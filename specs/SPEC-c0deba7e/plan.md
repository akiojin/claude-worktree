# 実装計画: AIツール(Claude Code / Codex CLI)のbunx移行

**仕様ID**: `SPEC-c0deba7e` | **日付**: 2025-10-25 | **仕様書**: [spec.md](./spec.md)
**入力**: `/specs/SPEC-c0deba7e/spec.md` からの機能仕様

## 概要

@akiojin/claude-worktreeプロジェクトにおいて、Claude CodeとCodex CLIの起動方式をnpxからbunxへ完全移行します。Codex CLIは既にbunx対応済みのため、主な作業はClaude Codeのbunx移行と、UI/ドキュメントの統一です。この変更により、Bunを標準とするワークフローでの一貫性と高速化を実現します。

**主要な変更点**:
1. Claude Code起動コマンドをnpxからbunxへ変更
2. bunx未導入環境でのエラーメッセージとガイダンスの追加
3. UI表示文言の更新（bunx表記への統一）
4. ドキュメントの更新（README、トラブルシューティング）

## 技術コンテキスト

**言語/バージョン**: TypeScript 5.8.3 / Bun 1.0.0+
**ランタイム**: Bun 1.0.0+（必要に応じてNode.js 18.0.0+を併用可能）
**主要な依存関係**:
- `execa` (^9.6.0) - 外部コマンド実行
- `chalk` (^5.4.1) - コンソール出力の色付け
- `@inquirer/prompts` (^6.0.1) - 対話型プロンプト

**ストレージ**: なし（設定ファイルのみ）
**テスト**: Vitest 2.1.8
**ターゲットプラットフォーム**: Linux / macOS / Windows（WSL）
**プロジェクトタイプ**: CLIツール（単一パッケージ）
**パフォーマンス目標**: bunx起動時間5秒以内（既存npxと同等以上）
**制約**:
- Bun 1.0.0以上必須
- 既存の`-r`/`-c`オプション互換性維持
- npx対応は廃止（bunxへ完全移行）

**スケール/範囲**: 個人開発者向けCLIツール、同時実行数は想定しない

## 原則チェック

*ゲート: constitution.mdが未定義のため、スキップ*

✅ **既存コードベースとの整合性**
- 現状: Codex CLIは既にbunx対応済み（`src/codex.ts`）
- 変更: Claude Codeのみnpxからbunxへ移行
- 理由: コードベース内の一貫性を保つため

✅ **後方互換性**
- 変更: npx対応を廃止し、bunxへ完全移行
- 影響: Bun未導入ユーザーは明確なエラーメッセージでガイダンスを受ける
- 正当化: 範囲外に「npx対応の維持」が明記されている

## プロジェクト構造

### ドキュメント（この機能）

```text
specs/SPEC-c0deba7e/
├── spec.md              # 機能仕様（完了）
├── plan.md              # このファイル
├── research.md          # 技術調査（生成予定）
├── data-model.md        # データモデル（生成予定）
├── quickstart.md        # クイックスタート（生成予定）
└── tasks.md             # タスクリスト（/speckit.tasksで生成）
```

### ソースコード（リポジトリルート）

```text
src/
├── claude.ts                   # 🔧 Claude Code起動ロジック（npx→bunx変更対象）
├── codex.ts                    # ✅ Codex CLI起動ロジック（既にbunx対応済み）
├── ui/
│   ├── prompts.ts              # 🔧 対話型UI表示文言（bunx表記へ更新対象）
│   └── display.ts              # 表示フォーマット
├── index.ts                    # メインエントリーポイント
└── utils.ts                    # ユーティリティ

docs/
├── troubleshooting.md          # 🔧 トラブルシューティング（bunx前提へ更新対象）
└── api.md                      # APIドキュメント

README.md                        # 🔧 メインドキュメント（bunx表記へ更新対象）
README.ja.md                     # 🔧 日本語ドキュメント（bunx表記へ更新対象）

tests/
├── unit/
│   ├── claude.test.ts          # 🔧 Claude Code起動テスト（bunx対応へ更新）
│   └── codex.test.ts           # ✅ Codex CLIテスト（既存）
└── integration/
    └── ai-tool-launch.test.ts  # 🔧 統合テスト（bunx検証追加）
```

**凡例**:
- 🔧 変更対象
- ✅ 既に対応済み / 変更不要

## フェーズ0: 調査（技術スタック確認）

**目的**: 既存実装を分析し、bunx移行のパターンを確認

**出力**: `specs/SPEC-c0deba7e/research.md`

### 調査項目

1. **既存のCodex CLI bunx実装分析**
   - `src/codex.ts`のbunx起動パターン
   - エラーハンドリング方法
   - Windows対応のトラブルシューティングメッセージ

2. **Claude Code起動の現状確認**
   - `src/claude.ts`のnpx起動実装
   - オプション引数のパススルー方法
   - 実行モード（normal/continue/resume）の処理

3. **Bunパッケージの可用性確認**
   - `@anthropics/claude-code`パッケージのbunx互換性
   - `@openai/codex`パッケージのbunx互換性（既に確認済み）

4. **エラーメッセージのパターン統一**
   - Bunインストール手順の案内方法
   - Windows固有のトラブルシューティング
   - PATH更新手順の説明

## フェーズ1: 設計（実装パターン定義）

**目的**: bunx移行の実装パターンとデータモデルを定義

**出力**:
- `specs/SPEC-c0deba7e/data-model.md`
- `specs/SPEC-c0deba7e/quickstart.md`

### 1.1 データモデル設計

**ファイル**: `data-model.md`

この機能は主にコマンド実行ロジックの変更であり、永続化データは含みません。以下のランタイムエンティティを定義：

- **LaunchCommand**: AIツール起動コマンドの構成
  - ツールタイプ（claude/codex）
  - 実行モード（normal/continue/resume）
  - 追加引数
  - bunx実行パラメータ

- **ErrorGuidance**: bunx未導入環境のエラーメッセージ
  - プラットフォーム検出（Windows/Linux/macOS）
  - インストール手順
  - PATH更新ガイダンス

### 1.2 クイックスタートガイド

**ファイル**: `quickstart.md`

開発者向けの移行ガイド：
- bunx移行の背景と目的
- ローカル開発環境でのbunx動作確認手順
- npxからbunxへの変更差分
- トラブルシューティング

### 1.3 契約/インターフェース

**該当なし**: CLIツールの内部実装変更のため、外部APIは存在しません。

## フェーズ2: タスク生成

**次のステップ**: `/speckit.tasks` コマンドを実行

**入力**: このプラン + 仕様書 + 設計ドキュメント

**出力**: `specs/SPEC-c0deba7e/tasks.md` - 実装のための実行可能なタスクリスト

**想定タスク構成**:
1. **セットアップタスク**: 環境準備、依存関係確認
2. **US1実装**: Claude Code bunx移行
3. **US2実装**: エラーメッセージとガイダンス追加
4. **US3実装**: UI/ドキュメント更新
5. **テストタスク**: ユニット、統合、E2Eテスト
6. **ドキュメントタスク**: README、トラブルシューティング更新

## 実装戦略

### 優先順位付け

ユーザーストーリーの優先度に基づいて実装：
1. **P1 - US1**: Bun環境でAIツールを即時起動
   - Claude Code起動コマンドをbunxへ変更
   - 既存のCodex CLI bunxパターンに合わせる
   - 引数パススルー機能の維持

2. **P2 - US2**: Bun未導入環境へのガイダンス
   - bunx未検出時のエラーメッセージ追加
   - Bunインストール手順の日本語案内
   - Windows固有のPATH更新ガイダンス

3. **P3 - US3**: UIとドキュメントの整合性
   - UI表示文言をbunx表記へ更新
   - README/トラブルシューティングのnpx→bunx変更
   - 一貫性チェック（grep検索でnpx表記の残存確認）

### 独立したデリバリー

各ユーザーストーリーは独立して実装・テスト可能：
- **US1完了** → bunx経由でClaude Code起動可能（Bun導入済み環境）
- **US2追加** → Bun未導入環境で適切なエラーガイダンス表示
- **US3追加** → UI/ドキュメントがbunx表記で統一

### 変更範囲の最小化

既存のCodex CLI bunx実装をリファレンスとして活用：
- `src/codex.ts`のbunx起動パターンをClaude Codeに適用
- エラーハンドリングロジックの再利用
- Windowsトラブルシューティングメッセージのテンプレート化

## テスト戦略

### ユニットテスト

**対象**: `src/claude.ts`, `src/ui/prompts.ts`

- **bunx起動コマンド生成**: 各実行モード（normal/continue/resume）で正しいbunxコマンドが生成されるか
- **引数パススルー**: `extraArgs`が正しくbunxコマンドに渡されるか
- **エラーハンドリング**: bunx未導入時に適切なエラーメッセージが生成されるか
- **プラットフォーム検出**: Windows環境で固有のガイダンスが表示されるか

### 統合テスト

**対象**: AIツール起動フロー全体

- **Bun導入済み環境**: Claude Code/Codexがbunx経由で正常に起動するか
- **Bun未導入環境**: 適切なエラーメッセージとインストール手順が表示されるか
- **引数互換性**: `-r`/`-c`オプションがbunx経由でも期待どおりに動作するか
- **Windows環境**: PATH更新ガイダンスが表示されるか

### E2Eテスト

**対象**: エンドユーザーシナリオ

- **シナリオ1**: Bun導入済み環境でClaude Codeを起動し、セッションが開始される
- **シナリオ2**: Bun未導入環境で起動を試み、明確なエラーメッセージが表示される
- **シナリオ3**: `-c`オプションで前回のセッションが継続される
- **シナリオ4**: UI表示でbunx表記が一貫して使用されている

### ドキュメントテスト

**対象**: README、トラブルシューティング

- **npx表記の残存チェック**: `grep -r "npx"`でnpx表記が残っていないか確認
- **bunx表記の統一**: すべてのAIツール起動例で`bunx`が使用されているか確認
- **リンク切れチェック**: Bun公式ドキュメントへのリンクが有効か確認

## リスクと緩和策

### 技術的リスク

1. **リスク**: `@anthropics/claude-code`パッケージがbunxで正しく動作しない可能性
   - **緩和策**: 事前にローカル環境でbunx起動テストを実施
   - **フォールバック**: 問題が発生した場合、issue報告と回避手順をドキュメント化

2. **リスク**: 既存ユーザーがBun未導入で戸惑う可能性
   - **緩和策**: 明確なエラーメッセージとインストール手順を日本語で提供
   - **緩和策**: README冒頭に「Bun 1.0+必須」を明記

3. **リスク**: Windows環境でのPATH設定が複雑
   - **緩和策**: Windows固有のトラブルシューティングセクションを充実
   - **緩和策**: PowerShellとコマンドプロンプトの両方の手順を記載

### 依存関係リスク

1. **依存関係**: Bun公式配布チャネル
   - **リスク**: Bunのインストール方法が変更される可能性
   - **緩和策**: Bun公式ドキュメントへのリンクを最新に保つ
   - **緩和策**: 定期的にインストール手順の検証

2. **依存関係**: `@anthropics/claude-code`パッケージの継続提供
   - **リスク**: パッケージ名やAPIが変更される可能性
   - **緩和策**: パッケージバージョンを`@latest`で固定し、常に最新を使用
   - **緩和策**: 変更があった場合の迅速な対応体制

## 次のステップ

1. ✅ フェーズ0開始: 既存コードベース分析（完了）
2. ⏭️ フェーズ0完了: research.md生成
3. ⏭️ フェーズ1完了: data-model.md, quickstart.md生成
4. ⏭️ `/speckit.tasks` を実行してタスクを生成
5. ⏭️ `/speckit.implement` で実装を開始
