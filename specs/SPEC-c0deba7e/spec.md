# 機能仕様: AIツール(Claude Code / Codex CLI)のbunx移行

**仕様ID**: `SPEC-c0deba7e`
**作成日**: 2025-10-25
**ステータス**: ドラフト
**入力**: ユーザー説明: "Claude CodeとCodex CLIの実行をnpxからbunxへ置き換え、/speckit.specify向け要件を整備する"

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - Bun環境でAIツールを即時起動 (優先度: P1)

開発者として、既にBunを利用している環境でClaude CodeまたはCodex CLIをワンクリックで起動したい。

**この優先度の理由**: Bunを標準とするワークフローで待ち時間なくAIツールを利用できるかが導入可否を決めるため。

**独立したテスト**: Bunがインストールされたクリーンな環境でCLIを起動し、エラーなくAIツールセッションが開始されるかを確認する。

**受け入れシナリオ**:

1. **前提条件** Bun 1.0以降がインストール済み、**操作** Claude Codeコマンドを実行、**期待結果** bunx経由でClaude Codeが起動し、ユーザー入力を受け付ける。
2. **前提条件** Bun 1.0以降がインストール済み、**操作** codexコマンドを実行、**期待結果** bunx経由でCodexが起動し、ユーザー入力を受け付ける。
3. **前提条件** AIツールが追加引数付きで起動される、**操作** Claude Codeの`-r`や`-c`、Codexの`resume --last`や`resume <id>`コマンドを利用、**期待結果** bunx経由でも同等に動作する。

---

### ユーザーストーリー 2 - Bun未導入環境へのガイダンス (優先度: P2)

開発者として、Bunを導入していないPCでAIツールを起動しようとしたときに、最小限の手順で問題を自己解決したい。

**この優先度の理由**: bunx移行後にもっとも発生しやすい失敗パターンを迅速に解決できる必要があるため。

**独立したテスト**: Bunがインストールされていない環境でAIツールを起動し、エラー内容と案内が適切かを確認する。

**受け入れシナリオ**:

1. **前提条件** Bun未導入、**操作** Claude CodeまたはCodexコマンドを実行、**期待結果** bunxが見つからない旨とインストール手順が日本語で提示される。
2. **前提条件** Windows端末、**操作** AIツールコマンドを実行、**期待結果** BunインストールとPATH更新を促す具体的な手順が表示される。

---

### ユーザーストーリー 3 - UIとドキュメントの整合性 (優先度: P3)

新規メンバーとして、CLI UIやドキュメントの案内が実際の実行方法と一致していてほしい。

**この優先度の理由**: 表記揺れや古い記述が残ると学習コストが増大するため。

**独立したテスト**: 対話型UIと関連ドキュメントを確認し、`bunx`が一貫して案内されているかを検証する。

**受け入れシナリオ**:

1. **前提条件** AIツール選択メニューを表示、**操作** 候補一覧を確認、**期待結果** Claude CodeとCodexの説明文にbunxでの実行が明記されている。
2. **前提条件** トラブルシューティングページを参照、**操作** bunx関連セクションを確認、**期待結果** Windows向けの対処がbunx前提で説明されている。

---

### ユーザーストーリー 4 - ローカルインストールClaude Codeの自動優先 (優先度: P1)

開発者として、公式インストール方法でClaude Codeをローカルにインストール済みの場合、それを優先的に使用したい。

**この優先度の理由**: 公式インストール版は最適化されており、起動が高速で安定性が高い。bunxは便利だが、インストール済みのツールがあればそれを使う方が開発体験が向上するため。

**独立したテスト**: ローカルに`claude`コマンドがインストールされた環境と、されていない環境の両方でCLIを起動し、適切な方式が選択されるかを確認する。

**受け入れシナリオ**:

1. **前提条件** claude コマンドがローカルにインストール済み、**操作** Claude Codeコマンドを実行、**期待結果** ローカルインストール版claudeコマンドが優先的に使用され、起動する。
2. **前提条件** claude コマンドがローカルにインストールされていない、**操作** Claude Codeコマンドを実行、**期待結果** bunx経由でClaude Codeが起動する（フォールバック）。
3. **前提条件** どちらの環境でも、**操作** `-r`や`-c`オプション付きで起動、**期待結果** 両方式で同じ引数が正しく動作する。
4. **前提条件** ローカルインストール版使用時、**操作** 起動ログを確認、**期待結果** どちらの方式で起動したかがログに出力される。

---

### エッジケース

- Bunのバージョンが1.0未満の場合、互換性のない挙動を検出しユーザーに更新を促す必要があるか。
- 既存環境にNode/npmのみがある場合でも、Bun導入手順を案内するメッセージで十分か。

## 要件 *(必須)*

### 機能要件

- **FR-001**: Claude Codeは`@anthropics/claude-code`を`bunx`コマンドで起動し、Codex CLIは`@openai/codex`を`bunx`コマンドで起動しなければならない。
- **FR-002**: `bunx`が見つからない場合、Bunの入手方法とPATH更新手順を含むエラーメッセージを表示しなければならない。
- **FR-003**: Claude Codeの`-r`および`-c`コマンド、Codex CLIの`resume --last`および`resume <id>`コマンドはbunx実行でも期待どおりに動作しなければならない。
- **FR-004**: 対話型UIのClaude Code説明文は`bunx @anthropics/claude-code@latest`表記を、Codex説明文は`bunx @openai/codex@latest`表記を表示しなければならない。
- **FR-005**: トラブルシューティングドキュメントはbunx前提の手順に更新され、両AIツールとWindows固有の案内を含めなければならない。
- **FR-006**: システムに`claude`コマンドが存在する場合、bunxよりも優先してローカルインストール版を使用しなければならない。
- **FR-007**: コマンド検出ロジックはUnix系では`which`、Windows系では`where`コマンドを使用してClaude Codeの存在を確認しなければならない。

### 主要エンティティ *(機能がデータを含む場合は含める)*

- **AIツール起動コマンド**: bunxを通じてClaude CodeまたはCodex CLIを呼び出す操作。利用可能なモードや追加引数を保持する。
- **ユーザー環境**: BunおよびPATH設定の有無を含むローカル開発環境。エラーハンドリングとガイダンスの対象。

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: Bun 1.0以降がインストールされた環境でClaude CodeまたはCodex起動コマンドを発行すると、エラーなくプロセスが開始されること。
- **SC-002**: Bun未導入環境で起動した際、ユーザーが追加情報なしでBun導入手順を理解できるメッセージが表示されること。
- **SC-003**: 対話型UIおよび関連ドキュメントを検索した際、`npx`表記が残存せず`bunx`表記に統一されていること。
- **SC-004**: Claude Codeの`-r`/`-c`、Codexの`resume --last`/`resume <id>`を含むコマンド実行時、bunx移行による振る舞いの差異が検出されないこと。
- **SC-005**: ローカルに`claude`コマンドがインストールされている環境で起動した際、ローカルインストール版が優先的に使用されること。
- **SC-006**: ローカルに`claude`コマンドがインストールされていない環境で起動した際、bunx経由でのフォールバックが正常に動作すること。
- **SC-007**: 起動時にどちらの方式（ローカルインストール版またはbunx）で起動したかがログに出力されること。

## 制約と仮定 *(該当する場合)*

### 制約

- Bun 1.0.0以上がユーザー環境にインストールされていることを前提に最適化する。
- `@anthropics/claude-code`および`@openai/codex`パッケージのbunx実行が公式にサポートされていること。

### 仮定

- ユーザーは既にBunの導入を許容できる（Node/npmしか利用できない環境は対象外）。
- 既存のClaude CodeおよびCodex関連機能はbunx実行により追加の権限設定を必要としない。

## 範囲外 *(必須)*

次の項目は、この機能の範囲外です：

- Bun自体のインストール自動化スクリプトを提供すること。
- AIツール（Claude Code / Codex CLI）のバージョン固定や機能拡張。
- npx対応の維持（bunxへ完全移行）。

## セキュリティとプライバシーの考慮事項 *(該当する場合)*

- Bun導入による追加権限要求は発生しないため、新たなセキュリティリスクは想定していない。
- エラーメッセージには機密情報（パスなど）を含めず、一般的な手順のみを記載する。

## 依存関係 *(該当する場合)*

- Bun公式配布チャネル（brew、curlスクリプト等）。
- `@anthropics/claude-code` npmパッケージの継続的提供。
- `@openai/codex` npmパッケージの継続的提供。

## 参考資料 *(該当する場合)*

- プロジェクトREADME内のSpec Kitワークフロー説明。
- Bun公式ドキュメント（[https://bun.sh/docs/cli/bunx](https://bun.sh/docs/cli/bunx)）。
