# 機能仕様: 一括ブランチマージ機能

**仕様ID**: `SPEC-ee33ca26`
**作成日**: 2025-10-27
**ステータス**: ドラフト
**入力**: ユーザー説明: "ブランチ一覧画面から、全てのローカルブランチに対してmain/developから最新の変更を一括でマージする機能"

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - 基本的な一括マージ (優先度: P1)

開発者が複数のfeatureブランチで作業している場合、main/developブランチの最新変更を全ブランチに反映するため、ブランチ一覧画面から'p'キーを押下することで、全てのローカルブランチ(main/develop除く)に対して一括でマージを実行できる。

**この優先度の理由**: コア機能であり、複数ブランチを手動で切り替えてマージする手間を大幅に削減し、開発効率を向上させる。この機能単体で価値を提供できる。

**独立したテスト**: 3つのfeatureブランチを作成し、mainブランチに変更を加えた後、一括マージを実行して全ブランチにmainの変更が反映されることを確認することでテストできる。

**受け入れシナリオ**:

1. **前提条件**: 5個のローカルブランチ(main, develop, feature/a, feature/b, hotfix/c)が存在し、mainに新しいコミットがある。**操作**: ブランチ一覧画面で'p'キーを押下し、確認ダイアログで実行を選択。**期待結果**: feature/a, feature/b, hotfix/cの3ブランチにmainの変更がマージされ、進捗表示と成功サマリーが表示される。

2. **前提条件**: 対象ブランチのいくつかにworktreeが存在しない。**操作**: 一括マージを実行。**期待結果**: worktreeが存在しないブランチには自動的にworktreeが作成され、マージが実行される。

3. **前提条件**: マージ元ブランチとしてmainとdevelopが両方存在する。**操作**: 一括マージを実行。**期待結果**: 優先順位(main > develop > master)に従い、mainが自動的にマージ元として選択される。

4. **前提条件**: 一部のブランチでマージコンフリクトが発生する。**操作**: 一括マージを実行。**期待結果**: コンフリクトが発生したブランチはスキップされ、エラーログに記録される。残りのブランチは正常にマージが完了し、結果サマリーに成功/スキップが表示される。

---

### ユーザーストーリー 2 - ドライランモード (優先度: P2)

開発者が実際にマージを実行する前に、どのブランチがマージ可能か、どのブランチでコンフリクトが発生するかを事前に確認したい場合、ドライランモードを有効にして実行することで、実際の変更を加えずにシミュレーション結果を確認できる。

**この優先度の理由**: リスク低減のための重要な機能だが、P1の基本機能がなければ意味をなさないため、P2とする。独立して開発・テスト可能。

**独立したテスト**: ドライランモードで実行後、各ブランチの最新コミットハッシュが変更されていないことを確認し、かつシミュレーション結果が正確に表示されることでテストできる。

**受け入れシナリオ**:

1. **前提条件**: 複数のブランチが存在し、一部でコンフリクトが予想される。**操作**: ドライランモードを有効にして一括マージを実行。**期待結果**: どのブランチも実際には変更されず、「○個のブランチがマージ可能」「○個でコンフリクトが発生する可能性」というシミュレーション結果が表示される。

2. **前提条件**: ドライランモードで実行済み。**操作**: シミュレーション結果を確認後、通常モードで再実行。**期待結果**: 実際のマージが実行され、ドライランの予測と同じ結果が得られる。

---

### ユーザーストーリー 3 - マージ後の自動プッシュ (優先度: P3)

開発者がマージ後の変更を即座にリモートリポジトリに反映させたい場合、自動プッシュオプションを有効にすることで、マージ成功後に自動的にリモートへプッシュされる。

**この優先度の理由**: 便利機能だが、手動でpushすることも可能なため、P3とする。P1, P2がなくても独立して価値は低いが、組み合わせることで開発フローが更に効率化される。

**独立したテスト**: 自動プッシュオプションを有効にして実行後、リモートリポジトリの各ブランチにマージコミットが反映されていることを確認することでテストできる。

**受け入れシナリオ**:

1. **前提条件**: 自動プッシュオプションが有効。**操作**: 一括マージを実行。**期待結果**: マージが成功した全ブランチについて、自動的にリモートへプッシュされる。進捗表示に「プッシュ中...」が表示される。

2. **前提条件**: 一部のブランチでリモートプッシュが失敗する(ネットワークエラーなど)。**操作**: 自動プッシュオプションを有効にして実行。**期待結果**: プッシュ失敗したブランチはエラーログに記録されるが、処理は継続される。結果サマリーに「マージ成功・プッシュ失敗」が表示される。

---

### ユーザーストーリー 4 - リアルタイム進捗表示 (優先度: P1)

開発者が多数のブランチに対して一括マージを実行する場合、現在どのブランチを処理中か、全体の進捗率、経過時間をリアルタイムで確認できることで、処理の進行状況を把握し、完了までの見通しを持つことができる。

**この優先度の理由**: UX改善の重要な要素であり、長時間の処理でユーザーが不安にならないために必須。P1の基本機能と同時に実装すべき。

**独立したテスト**: 10個のブランチに対して一括マージを実行し、画面に「処理中: feature/a (3/10)」「進捗: 30%」「経過時間: 1分23秒」が表示されることを確認することでテストできる。

**受け入れシナリオ**:

1. **前提条件**: 10個のブランチが対象。**操作**: 一括マージを実行。**期待結果**: 画面に現在処理中のブランチ名、進捗率(X/Y形式とパーセンテージ)、開始からの経過時間がリアルタイムで更新表示される。

2. **前提条件**: 一括マージ実行中。**操作**: 進捗を観察。**期待結果**: 各ブランチの処理が完了するたびに進捗率が更新され、次のブランチ名が表示される。

---

### エッジケース

- **対象ブランチが0個の場合**: main/develop以外のローカルブランチが存在しない場合、「対象ブランチがありません」というメッセージを表示して処理を終了する。
- **マージ元ブランチが存在しない場合**: main, develop, masterのいずれも存在しない場合、エラーメッセージ「マージ元ブランチを特定できません」を表示して処理を中止する。
- **全ブランチでコンフリクトが発生する場合**: 全対象ブランチでマージコンフリクトが発生した場合、結果サマリーに「成功: 0件、スキップ(コンフリクト): N件」を表示し、手動解決を促すメッセージを表示する。
- **worktree作成に失敗する場合**: ディスク容量不足などでworktree作成に失敗した場合、そのブランチをスキップし、エラーログに記録して次のブランチを処理する。
- **現在のブランチが処理対象に含まれる場合**: 実行時に現在いるブランチが対象に含まれる場合でも、worktree経由でマージを実行するため問題なく処理できる。
- **ユーザーが処理を途中でキャンセルする場合**: 'q'キーまたはCtrl+Cで処理を中断した場合、現在処理中のブランチはマージを中止(git merge --abort)し、それまでの処理結果をサマリー表示する。

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムはブランチ一覧画面で'p'キーが押下された時、一括マージ機能を起動**しなければならない**
- **FR-002**: システムは実行前に「対象ブランチ数: N件」「マージ元: main」「オプション: ドライラン/自動プッシュ」を表示する確認ダイアログを提示**しなければならない**
- **FR-003**: システムはローカルブランチ一覧から、main, develop, masterを除外した全てのブランチを対象として抽出**しなければならない**
- **FR-004**: システムはmain, develop, masterの優先順位でマージ元ブランチを自動判定**しなければならない**
- **FR-005**: システムはマージ実行前に`git fetch --all --prune`を実行してリモートの最新情報を取得**しなければならない**
- **FR-006**: システムは対象ブランチにworktreeが存在しない場合、自動的にworktreeを作成**しなければならない**
- **FR-007**: システムは各ブランチに対して`git merge <マージ元>`を実行**しなければならない**
- **FR-008**: システムはマージコンフリクトが発生した場合、`git merge --abort`で中止し、そのブランチをスキップして次のブランチを処理**しなければならない**
- **FR-009**: システムは処理中に現在のブランチ名、進捗率(X/Y形式とパーセンテージ)、経過時間をリアルタイムで画面に表示**しなければならない**
- **FR-010**: システムは全ブランチの処理完了後、「成功: N件」「スキップ(コンフリクト): M件」「失敗: L件」という結果サマリーを表示**しなければならない**
- **FR-011**: システムはドライランモードが有効な場合、実際のマージを実行せず、マージ可能性のシミュレーション結果のみを表示**しなければならない**
- **FR-012**: システムは自動プッシュオプションが有効な場合、マージ成功後に`git push origin <ブランチ名>`を実行**しなければならない**
- **FR-013**: システムはプッシュに失敗した場合でも処理を継続し、結果サマリーに「マージ成功・プッシュ失敗」を記録**しなければならない**
- **FR-014**: システムはユーザーが'q'キーまたはCtrl+Cで処理を中断した場合、現在処理中のブランチのマージを中止し、それまでの結果を表示**しなければならない**
- **FR-015**: システムは各ブランチの処理結果(成功/スキップ/失敗)を画面上のログとして表示**しなければならない**

### 主要エンティティ

- **BatchMergeConfig**: 一括マージの設定情報。マージ元ブランチ名(例: "main")、対象ブランチリスト、ドライランモードフラグ(true/false)、自動プッシュフラグ(true/false)を含む。
- **BatchMergeProgress**: リアルタイム進捗情報。現在処理中のブランチ名、処理済みブランチ数、総ブランチ数、進捗率(0-100%)、経過時間(秒)を含む。
- **BranchMergeStatus**: 各ブランチの処理結果。ブランチ名、ステータス(success/skipped/failed)、エラーメッセージ(失敗時)、プッシュ結果(成功/失敗/未実行)を含む。
- **BatchMergeResult**: 一括マージの最終結果。全BranchMergeStatusのリスト、成功件数、スキップ件数、失敗件数、総処理時間を含む。

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: ユーザーは5つのブランチに対する一括マージを1分以内に完了できる(コンフリクトなしの場合)
- **SC-002**: システムは20個のブランチを同時に処理でき、各ブランチの進捗をリアルタイムで正確に表示できる
- **SC-003**: コンフリクトが発生したブランチは自動的にスキップされ、他のブランチの処理は継続される(成功率: コンフリクトなしブランチで100%)
- **SC-004**: ドライランモードは実際のブランチに一切の変更を加えず、シミュレーション結果の精度は90%以上である（精度の定義: ドライラン実行時のコンフリクト検出予測と、実際のマージ実行時の結果との一致率。10回のマージシミュレーションのうち9回以上で、コンフリクト有無の予測が実際の結果と一致すること）
- **SC-005**: 自動プッシュオプションにより、マージ成功後のリモート反映作業が完全に自動化される(手動プッシュ作業0回)
- **SC-006**: ユーザーは進捗表示により、処理の残り時間を予測でき、長時間処理でも不安なく待つことができる
- **SC-007**: 一括マージ機能により、複数ブランチの手動マージと比較して作業時間が80%以上削減される

## 制約と仮定 *(該当する場合)*

### 制約

- 既存のworktree管理システムと統合する必要がある
- 現在のブランチから切り替えずに処理を実行する必要がある(worktree設計思想に準拠)
- ブランチの作成・削除は行わず、既存のローカルブランチに対してのみマージを実行する
- コンフリクト解決は手動で行う必要があり、自動解決は行わない

### 仮定

- ユーザーはgitリポジトリのルートディレクトリで実行している
- リモートリポジトリ(origin)が設定されている
- ユーザーはgitの基本的なマージ操作とコンフリクト解決方法を理解している
- 対象ブランチは既にリモートにプッシュ済みである(自動プッシュ機能使用時)
- ディスク容量は全ブランチのworktree作成に十分である

## 範囲外 *(必須)*

次の項目は、この機能の範囲外です：

- インタラクティブなコンフリクト解決機能(ユーザーが手動で解決する)
- 特定のブランチを選択してマージする機能(全ブランチが対象)
- rebase操作(mergeのみサポート)
- マージコミットメッセージのカスタマイズ(デフォルトのマージメッセージを使用)
- ロールバック機能(マージ後の取り消し)
- メールやSlackなどへの通知機能
- マージ結果のログファイル保存(画面表示のみ)
- 並列処理(ブランチを順次処理)
- リモートブランチへの直接マージ(ローカルブランチのみ対象)

## セキュリティとプライバシーの考慮事項 *(該当する場合)*

- git操作は全てローカルリポジトリに対して実行され、外部サービスへの通信は発生しない(git fetch/pushを除く)
- 認証情報はgitの標準的な認証メカニズム(SSH鍵、credential helper)を使用し、本機能では扱わない
- 処理ログは画面表示のみで、ファイルやネットワークへの出力は行わないため、情報漏洩リスクは低い

## 依存関係 *(該当する場合)*

- 既存のgit操作モジュール(git.ts)
- 既存のworktree作成・管理機能(worktree.ts)
- ブランチ一覧画面(BranchListScreen)
- git コマンドラインツール(バージョン2.5以上)

## 参考資料 *(該当する場合)*

- [Git公式ドキュメント - git merge](https://git-scm.com/docs/git-merge)
- [Git Worktree公式ドキュメント](https://git-scm.com/docs/git-worktree)
- [プロジェクトREADME](../../README.md)
- [CLAUDE.md - 開発ガイドライン](../../CLAUDE.md)
