# タスク: Docker/root環境でのClaude Code自動承認機能

**仕様ID**: SPEC-8efcbf19
**入力**: `/specs/SPEC-8efcbf19/` からの設計ドキュメント
**前提条件**: plan.md、spec.md、research.md、quickstart.md

**構成**: タスクはユーザーストーリーごとにグループ化され、各ストーリーの独立した実装とテストを可能にします。

## フォーマット: `- [ ] [TaskID] [P?] [Story] Description with file path`

- **[P]**: 並列実行可能（異なるファイル、依存関係なし）
- **[Story]**: このタスクが属するユーザーストーリー（例: US1、US2、US3）
- 説明に正確なファイルパスを含める

## 実装戦略

### MVP デリバリー

- **MVP1 (US1完了後)**: Docker/root環境でClaude Codeが正常に起動
- **MVP2 (US2完了後)**: セキュリティ警告付きでユーザー体験向上
- **完全版 (US3完了後)**: 後方互換性完全保証

### 並列実行の機会

- US1とUS2は部分的に並列実行可能（警告メッセージは独立した追加）
- テストタスクはほとんど並列実行可能

---

## フェーズ1: セットアップ（既存プロジェクトへの追加）

**目的**: 既存のclaude.tsファイルの理解と準備

### 準備タスク

- [x] **T001** 既存のlaunchClaudeCode関数（src/claude.ts:17-134）を確認し、修正箇所を特定
- [x] **T002** 既存のexeca使用パターンとchalk使用パターンを確認

---

## フェーズ2: ユーザーストーリー1 - Docker/root環境での自動承認実行 (優先度: P1)

**ストーリー**: Docker環境でrootユーザーとして実行している際に、Claude Codeの`--dangerously-skip-permissions`フラグを使用してPermission promptなしでClaude Codeを実行したい。

**価値**: Docker/コンテナ環境でClaude Codeが正常に起動し、Permission promptが表示されない（MVP達成）

**独立したテスト基準**: Docker環境（root）でskipPermissions=trueでClaude Codeを起動し、エラーなく起動してPermission promptが表示されないこと

### 実装タスク

- [x] **T101** [US1] src/claude.tsのlaunchClaudeCode関数にrootユーザー検出ロジックを追加（process.getuid() === 0）
- [x] **T102** [US1] T101の後に、src/claude.tsでskipPermissions=true + root環境の場合にIS_SANDBOX=1環境変数を設定するロジックを追加
- [x] **T103** [US1] T102の後に、src/claude.tsのexeca呼び出しにenv設定を追加（isRoot && skipPermissions ? { ...process.env, IS_SANDBOX: '1' } : process.env）

### テストタスク

- [x] **T104** [P] [US1] tests/unit/claude.test.tsを作成し、rootユーザー検出ロジックのテストを追加
- [x] **T105** [P] [US1] tests/unit/claude.test.tsにskipPermissions=true + root環境でIS_SANDBOX=1が設定されることを検証するテストを追加
- [x] **T106** [P] [US1] tests/unit/claude.test.tsにskipPermissions=false + root環境でIS_SANDBOX=1が設定されないことを検証するテストを追加

### 検証タスク

- [x] **T107** [US1] T103の後に、Docker環境（node:22イメージ）でskipPermissions=trueでClaude Codeが起動することを手動検証（手順はquickstart.mdに記載）
- [x] **T108** [US1] T107の後に、Permission promptが表示されないことを手動検証（手順はquickstart.mdに記載）

**✅ MVP1チェックポイント**: US1完了後、Docker/root環境でClaude Codeが正常に動作（独立した価値提供）

---

## フェーズ3: ユーザーストーリー2 - セキュリティ警告の表示 (優先度: P2)

**ストーリー**: rootユーザーでPermission skipを使用する際に、セキュリティリスクについての警告メッセージを確認したい。

**価値**: ユーザーがセキュリティリスクを認識し、意図しない誤用を防ぐ

**独立したテスト基準**: rootユーザーでskipPermissions=trueで起動した際に、"Docker/サンドボックス環境として実行中（IS_SANDBOX=1）"という警告メッセージが表示されること

### 実装タスク

- [x] **T201** [US2] src/claude.tsのlaunchClaudeCode関数にrootユーザー + skipPermissions=trueの場合の警告メッセージ表示ロジックを追加
- [x] **T202** [US2] T201の後に、chalk.yellowを使用して"⚠️  Docker/サンドボックス環境として実行中（IS_SANDBOX=1）"メッセージを表示

### テストタスク

- [ ] **T203** [P] [US2] tests/unit/claude.test.tsに警告メッセージ表示のテストを追加（console.logのモック）
- [ ] **T204** [P] [US2] tests/unit/claude.test.tsにrootユーザー + skipPermissions=trueで警告が表示されることを検証するテストを追加
- [ ] **T205** [P] [US2] tests/unit/claude.test.tsに非root環境で警告が表示されないことを検証するテストを追加

### 検証タスク

- [ ] **T206** [US2] T202の後に、Docker環境で警告メッセージが表示されることを手動検証

**✅ MVP2チェックポイント**: US2完了後、セキュリティ警告付きでユーザー体験向上

---

## フェーズ4: ユーザーストーリー3 - 非rootユーザーでの既存動作維持 (優先度: P3)

**ストーリー**: 非rootユーザーでClaude Codeを実行する際に、既存の動作が変更されないことを確認したい。

**価値**: 後方互換性を完全に保証し、既存ユーザーへの影響をゼロにする

**独立したテスト基準**: 非rootユーザーでClaude Codeを起動し、既存の動作と同じであること（IS_SANDBOX=1が設定されない、警告が表示されない）

### 実装タスク

- [ ] **T301** [US3] src/claude.tsのrootユーザー検出ロジックにtry-catchを追加し、process.getuid()が存在しない環境でエラーが発生しないようにする
- [ ] **T302** [US3] T301の後に、process.getuid()が利用できない場合はisRoot=falseとして既存の動作を維持

### テストタスク

- [ ] **T303** [P] [US3] tests/unit/claude.test.tsに非rootユーザーでIS_SANDBOX=1が設定されないことを検証するテストを追加
- [ ] **T304** [P] [US3] tests/unit/claude.test.tsにprocess.getuid()が存在しない環境（Windowsなど）でエラーが発生しないことを検証するテストを追加
- [ ] **T305** [P] [US3] tests/integration/root-sandbox.test.tsを作成し、非root環境での既存動作維持を検証する統合テストを追加

### 検証タスク

- [ ] **T306** [US3] T302の後に、非rootユーザー環境でClaude Codeの動作が変わらないことを手動検証
- [ ] **T307** [US3] T306の後に、IS_SANDBOX=1環境変数が設定されないことを確認

**✅ 完全な機能**: US3完了後、すべての要件が満たされ、後方互換性が完全保証

---

## フェーズ5: 統合とポリッシュ

**目的**: すべてのストーリーを統合し、品質を確保

### 統合テスト

- [ ] **T401** [統合] tests/unit/claude.test.tsですべてのテストケースを実行し、カバレッジ95%以上を確認
- [ ] **T402** [統合] tests/integration/root-sandbox.test.tsで統合テストを実行し、すべてのシナリオが動作することを確認

### エッジケース処理

- [ ] **T403** [統合] src/claude.tsでIS_SANDBOX=1を設定してもClaude Codeがエラーを返す場合のエラーハンドリングを追加（既存のClaudeError使用）
- [ ] **T404** [統合] T403の後に、エラーメッセージに「IS_SANDBOX=1が動作しない可能性があります。GitHub Issue #3490を確認してください」を追加

### ドキュメント更新

- [ ] **T405** [P] [ドキュメント] README.mdにDocker/root環境での使用方法を追加
- [ ] **T406** [P] [ドキュメント] README.mdにセキュリティリスクと制限事項（Windows非対応、IS_SANDBOX=1は非公式）を明記
- [ ] **T407** [P] [ドキュメント] CHANGELOG.mdに機能追加を記載

### コード品質

- [ ] **T408** [品質] bun run lintを実行し、ESLintエラーを修正
- [ ] **T409** [品質] bun run format:checkを実行し、Prettierフォーマットを確認
- [ ] **T410** [品質] bun run type-checkを実行し、TypeScriptエラーを修正

### 最終検証

- [ ] **T411** [検証] Docker環境（node:22イメージ）でE2Eテストを実行
- [ ] **T412** [検証] 非root環境でE2Eテストを実行
- [ ] **T413** [検証] bun run buildを実行し、ビルドが成功することを確認

### コミット & プッシュ

- [ ] **T414** [デプロイ] 変更点を日本語でコミットログに記載（feat: Docker/root環境でClaude Code自動承認機能を追加）
- [ ] **T415** [デプロイ] T414の後に、コミット＆プッシュを実行

---

## タスク凡例

### 優先度

- **P1**: 最も重要 - MVP1に必要（Docker/root環境での基本動作）
- **P2**: 重要 - MVP2に必要（セキュリティ警告）
- **P3**: 補完的 - 完全な機能に必要（後方互換性保証）

### 依存関係

- **[P]**: 並列実行可能（異なるファイル、依存関係なし）
- **依存あり**: "T###の後に"と明記されているタスク

### ストーリータグ

- **[US1]**: ユーザーストーリー1 - Docker/root環境での自動承認実行
- **[US2]**: ユーザーストーリー2 - セキュリティ警告の表示
- **[US3]**: ユーザーストーリー3 - 非rootユーザーでの既存動作維持
- **[統合]**: 複数ストーリーにまたがる統合タスク
- **[ドキュメント]**: ドキュメント専用タスク
- **[品質]**: コード品質チェックタスク
- **[検証]**: 最終検証タスク
- **[デプロイ]**: コミット＆プッシュタスク

---

## タスク依存関係グラフ

```
フェーズ1: セットアップ
  T001, T002 (並列可能)
    ↓
フェーズ2: US1 (MVP1)
  T101 → T102 → T103
  T104, T105, T106 (並列可能、T101-103と並行可能)
  T107 → T108
    ↓
フェーズ3: US2 (MVP2) - US1完了後に開始推奨
  T201 → T202
  T203, T204, T205 (並列可能、T201-202と並行可能)
  T206
    ↓
フェーズ4: US3 (完全版) - US1完了後に開始可能
  T301 → T302
  T303, T304, T305 (並列可能、T301-302と並行可能)
  T306 → T307
    ↓
フェーズ5: 統合とポリッシュ - US1, US2, US3完了後
  T401, T402 (並列可能)
  T403 → T404
  T405, T406, T407 (並列可能)
  T408, T409, T410 (並列可能)
  T411, T412, T413 (並列可能)
  T414 → T415
```

---

## 並列実行の例

### US1フェーズ（MVP1）

```bash
# 並列グループ1: 実装
T101 → T102 → T103

# 並列グループ2: テスト（実装と同時進行可能）
T104, T105, T106

# シーケンシャル: 検証
T107 → T108
```

### US2フェーズ（MVP2）

```bash
# 並列グループ1: 実装
T201 → T202

# 並列グループ2: テスト（実装と同時進行可能）
T203, T204, T205

# シーケンシャル: 検証
T206
```

### US3フェーズ（完全版）

```bash
# 並列グループ1: 実装
T301 → T302

# 並列グループ2: テスト（実装と同時進行可能）
T303, T304, T305

# シーケンシャル: 検証
T306 → T307
```

### 統合フェーズ

```bash
# 並列グループ1: 統合テスト
T401, T402

# シーケンシャル: エッジケース
T403 → T404

# 並列グループ2: ドキュメント
T405, T406, T407

# 並列グループ3: コード品質
T408, T409, T410

# 並列グループ4: 最終検証
T411, T412, T413

# シーケンシャル: デプロイ
T414 → T415
```

---

## 進捗追跡

- **完了したタスク**: `[x]` でマーク
- **進行中のタスク**: タスクIDの横にメモを追加
- **ブロックされたタスク**: ブロッカーを文書化
- **スキップしたタスク**: 理由と共に文書化

---

## タスク統計

- **総タスク数**: 45タスク
- **US1タスク数**: 8タスク（実装3 + テスト3 + 検証2）
- **US2タスク数**: 6タスク（実装2 + テスト3 + 検証1）
- **US3タスク数**: 7タスク（実装2 + テスト3 + 検証2）
- **統合・品質タスク数**: 15タスク
- **並列実行可能**: 約20タスク（全体の44%）

---

## 推奨実装順序

1. **MVP1優先** (US1): Docker/root環境での基本動作を最優先で実装
2. **MVP2追加** (US2): セキュリティ警告を追加してUX向上
3. **完全版** (US3): 後方互換性を保証して完成
4. **統合・ポリッシュ**: 品質を確保してリリース準備

**見積もり時間**:
- US1: 4-6時間
- US2: 2-3時間
- US3: 3-4時間
- 統合・ポリッシュ: 3-4時間
- **合計**: 12-17時間

---

## 注記

- 各タスクは30分から2時間で完了可能であるべき
- ファイルパスは正確で、プロジェクト構造（src/、tests/）と一致
- テストはVitest 2.1+を使用（既存のテストフレームワーク）
- 各ストーリーは独立してテスト・デプロイ可能
- MVP1完了時点でDocker環境での価値提供が可能
