# 機能仕様: Claude Code / Codex CLI 対応の対話型Gitワークツリーマネージャー

**仕様ID**: `SPEC-473b3d47`
**作成日**: 2025-10-24
**ステータス**: ドラフト
**入力**: ユーザー説明: "Claude Code / Codex CLI 対応の対話型Gitワークツリーマネージャー - ブランチ選択、ワークツリー作成、GitHub PR統合、AIツール統合、セッション管理、リリース管理の包括的機能"

## ユーザーシナリオとテスト

### ユーザーストーリー 1 - 対話型ブランチ選択とワークツリー自動作成 (優先度: P1)

開発者がGitリポジトリ内で異なるブランチ間を素早く切り替えながら作業したいとき、対話型インターフェースでローカルまたはリモートのブランチを選択し、自動的にワークツリーを作成してAIツール（Claude Code / Codex CLI）を起動できます。

**この優先度の理由**: これはツールの中核機能であり、開発者の最も一般的なユースケースに対応します。ブランチの切り替えとワークツリー管理を簡素化することで、開発効率を大幅に向上させます。

**独立したテスト**: ブランチ一覧を表示し、選択したブランチのワークツリーを作成し、AIツールを起動するまでの一連のフローをテストすることで、基本的な価値を提供できます。

**受け入れシナリオ**:

1. **前提条件** Gitリポジトリのルートディレクトリにいる、**操作** `claude-worktree`コマンドを実行、**期待結果** ローカルおよびリモートブランチの一覧がテーブル形式で表示される
2. **前提条件** ブランチ一覧が表示されている、**操作** 存在するブランチを選択、**期待結果** 既存ワークツリーがあればそのパスが表示され、なければワークツリー作成の確認が求められる
3. **前提条件** ワークツリー作成を確認、**操作** AIツール（Claude Code / Codex CLI）を選択、**期待結果** ワークツリーが作成され、選択したツールがそのディレクトリで起動される
4. **前提条件** リモートブランチを選択、**操作** ワークツリー作成を確認、**期待結果** ローカルブランチが自動的に作成され、ワークツリーがセットアップされる
5. **前提条件** 既存ワークツリーを持つブランチを選択、**操作** そのまま進行、**期待結果** 既存のワークツリーが再利用され、AIツールがそこで起動される

---

### ユーザーストーリー 2 - スマートブランチ作成ワークフロー (優先度: P1)

開発者が新しい機能、バグ修正、またはリリースのためのブランチを作成したいとき、ブランチタイプ（feature/hotfix/release）を選択し、適切なベースブランチからガイド付きで新規ブランチとワークツリーを作成できます。

**この優先度の理由**: 新規開発の開始は頻繁に発生するアクションであり、Git Flowに準拠したブランチ命名規則を自動適用することで、チーム開発での一貫性を保証します。

**独立したテスト**: メニューから「新規ブランチ作成」を選択し、タイプとベースブランチを指定してワークツリーを作成するまでの流れをテストできます。

**受け入れシナリオ**:

1. **前提条件** メインメニューが表示されている、**操作** 「新規ブランチ作成」を選択、**期待結果** ブランチタイプ選択画面（feature/hotfix/release）が表示される
2. **前提条件** ブランチタイプが選択済み、**操作** ブランチ名（タスク名）を入力、**期待結果** 自動的にプレフィックスが付与された完全なブランチ名が表示される（例: feature/新機能名）
3. **前提条件** ブランチ名が確定、**操作** ベースブランチを選択、**期待結果** 選択したベースブランチから新規ブランチが作成される
4. **前提条件** releaseタイプを選択、**操作** バージョンバンプタイプ（major/minor/patch）を選択、**期待結果** 現在のバージョンから新しいバージョンが計算され、`release/X.Y.Z`形式のブランチが作成される
5. **前提条件** releaseブランチが作成された、**操作** ワークツリーで作業開始、**期待結果** package.jsonのバージョンが自動的に更新されている

---

### ユーザーストーリー 3 - セッション管理と継続機能 (優先度: P2)

開発者が前回の作業を中断した後、同じワークツリーで作業を再開したいとき、`-c`オプションで最後のセッションを自動継続するか、`-r`オプションで過去のセッションから選択して復元できます。

**この優先度の理由**: 開発作業は頻繁に中断されるため、素早く作業を再開できる機能は生産性向上に大きく貢献します。

**独立したテスト**: セッションを保存し、`-c`オプションで再起動して同じワークツリーが開かれることを確認できます。

**受け入れシナリオ**:

1. **前提条件** 過去にワークツリーで作業したことがある、**操作** `claude-worktree -c`を実行、**期待結果** 最後に使用したワークツリーが自動的に開かれる
2. **前提条件** 複数のセッション履歴がある、**操作** `claude-worktree -r`を実行、**期待結果** 過去のセッション一覧が表示され、選択できる
3. **前提条件** セッションを選択、**操作** 確認して進行、**期待結果** 選択したセッションのワークツリーでAIツールが起動される
4. **前提条件** 最後のワークツリーが削除されている、**操作** `-c`オプションで起動、**期待結果** 警告メッセージが表示され、通常のメニューにフォールバックする

---

### ユーザーストーリー 4 - マージ済みPRの自動クリーンアップ (優先度: P2)

開発者がマージ済みのPRに対応するブランチとワークツリーを削除したいとき、GitHub CLI連携により自動検出して一括クリーンアップできます。

**この優先度の理由**: 長期開発では古いブランチとワークツリーが蓄積し、管理が煩雑になります。自動検出とクリーンアップ機能により、リポジトリを清潔に保てます。

**独立したテスト**: マージ済みPRを持つブランチを作成し、クリーンアップ機能でそれらが検出・削除されることを確認できます。

**受け入れシナリオ**:

1. **前提条件** GitHub CLI認証済み、**操作** ブランチ一覧画面で `c` キーを押下、**期待結果** リモートから最新情報を取得し、処理対象の1行目がスピナー（例: `⠋`）に、他の対象が待機アイコン（`⏳`）に差し替わる。
2. **前提条件** 追加で処理対象が存在する、**操作** 自動クリーンアップ進行中、**期待結果** 対象ごとにスピナー→結果アイコン（`✅`/`⏭️`/`❌`）へ切り替わり、全対象の処理が終了すると3秒間結果が表示されたのちに通常のカーソル表示に戻る。
3. **前提条件** クリーンアップ対象が存在しない、**操作** `c` キーを押下、**期待結果** 「クリーンアップ対象なし」のメッセージが表示され、UIはブランチ一覧のまま維持される。
4. **前提条件** 対象の一部に未コミットやアクセス不可のワークツリーが含まれる、**操作** `c` キーを押下、**期待結果** `⏭️`（または `⚠️`）付きでスキップ理由が表示され、3秒後に通常表示へ戻る。
5. **前提条件** クリーンアップ実行中にエラーが発生、**操作** `c` キーを押下、**期待結果** 対象行が `❌` に切り替わり、3秒後に通常表示へ戻る。
6. **前提条件** ブランチ／ワークツリー削除が成功、**操作** `c` キーを押下、**期待結果** `✅` が3秒間表示された後に該当ブランチ行が一覧から削除され、統計情報も更新される。

#### UIサンプル

```text
Claude Worktree - Branch Selection
Local: 6  Remote: 3  Worktrees: 2  Changes: 1

⠋ feature/add-dashboard
⏳ hotfix/urgent-fix
  ⚡🟢⭐ main

Processing... ⠙
[enter] Select  [n] New branch  [m] Manage worktrees  [c] Cleanup branches  [q] Quit
```

---

### ユーザーストーリー 5 - ワークツリー管理とライフサイクル操作 (優先度: P2)

開発者が既存のワークツリーを確認、開く、削除したいとき、管理メニューから対話的に操作できます。

**この優先度の理由**: ワークツリーの手動管理は時々必要であり、特に複数のワークツリーを並行して使用する開発者にとって重要です。

**独立したテスト**: 既存ワークツリーを一覧表示し、選択して開くまたは削除する操作をテストできます。

**受け入れシナリオ**:

1. **前提条件** 複数のワークツリーが存在、**操作** 「ワークツリー管理」を選択、**期待結果** 既存ワークツリーの一覧が表示される
2. **前提条件** ワークツリーを選択、**操作** 「開く」アクションを選択、**期待結果** そのワークツリーでAIツールが起動される
3. **前提条件** ワークツリーを選択、**操作** 「削除」アクションを選択、**期待結果** 確認後、ワークツリーが削除される（ブランチは残る）
4. **前提条件** ワークツリーを選択、**操作** 「削除（ブランチも）」を選択、**期待結果** 確認後、ワークツリーとブランチの両方が削除される
5. **前提条件** アクセス不可能なワークツリー（別環境で作成）が存在、**操作** 削除を試行、**期待結果** 強制削除オプションが提供され、Gitレコードから削除できる

---

### ユーザーストーリー 6 - リリース管理とGit Flowサポート (優先度: P3)

開発者がリリースブランチを作成してバージョン管理を行いたいとき、Git Flowに準拠したリリースワークフローを実行し、PR作成まで自動化できます。

**この優先度の理由**: リリース管理は頻度は低いものの重要なプロセスです。自動化により人的ミスを防ぎ、一貫性を保証します。

**独立したテスト**: リリースブランチを作成し、バージョン更新とPR作成までの流れをテストできます。

**受け入れシナリオ**:

1. **前提条件** プロジェクトにpackage.jsonが存在、**操作** releaseブランチを作成、**期待結果** バージョンバンプタイプの選択が求められる
2. **前提条件** バージョンバンプを選択、**操作** ワークツリーを作成、**期待結果** 新しいバージョンがpackage.jsonに自動反映される
3. **前提条件** リリース作業完了、**操作** 変更をコミット、**期待結果** リリースアクション選択（complete/continue/nothing）が表示される
4. **前提条件** 「complete」を選択、**操作** 実行、**期待結果** ブランチがプッシュされ、mainブランチへのPRが自動作成される
5. **前提条件** PRが作成された、**操作** PRマージ後の指示を確認、**期待結果** タグ作成とdevelopへのマージバック手順が表示される

---

### ユーザーストーリー 7 - AIツール統合と実行モード管理 (優先度: P1)

開発者がClaude Code または Codex CLI を選択して起動したいとき、対話的または`--tool`オプションで直接指定し、実行モード（通常/resume/continue）と権限設定を選択できます。

**この優先度の理由**: AIツールの統合はこのツールの主要な価値提案であり、開発者が最も頻繁に使用する機能です。

**独立したテスト**: AIツールを選択し、指定したワークツリーで起動することをテストできます。

**受け入れシナリオ**:

1. **前提条件** Claude Code / Codex CLI両方がインストール済み、**操作** ワークツリー選択時にツール選択画面を表示、**期待結果** 両方のオプションが表示され、選択できる
2. **前提条件** 片方のツールのみインストール済み、**操作** ワークツリーを作成、**期待結果** 利用可能なツールが自動選択される
3. **前提条件** コマンドライン引数で`--tool claude`を指定、**操作** 実行、**期待結果** Claude Codeが直接選択され、対話的選択をスキップする
4. **前提条件** ツールを選択、**操作** 実行モード選択画面で「resume」を選択、**期待結果** ツールがresumeモードで起動される
5. **前提条件** 実行モード選択後、**操作** 権限設定スキップオプションを選択、**期待結果** Claude Codeの場合、権限確認をスキップして起動される

---

### ユーザーストーリー 8 - 変更管理と開発セッション終了処理 (優先度: P2)

開発者がAIツールでの作業を終えた後、未コミットの変更をどう処理するか選択したいとき、対話的にcommit/stash/discardを選択できます。

**この優先度の理由**: 作業終了時の変更管理は重要であり、誤って変更を失わないようにするためのセーフガードが必要です。

**独立したテスト**: ワークツリーで変更を加え、終了時に変更管理オプションが表示され、各アクションが正しく実行されることを確認できます。

**受け入れシナリオ**:

1. **前提条件** ワークツリーで変更あり、**操作** AIツールを終了、**期待結果** 変更アクション選択画面（status/commit/stash/discard/continue）が表示される
2. **前提条件** 「status」を選択、**操作** 実行、**期待結果** `git status`の出力が表示され、再度選択画面に戻る
3. **前提条件** 「commit」を選択、**操作** コミットメッセージを入力、**期待結果** 変更がコミットされ、成功メッセージが表示される
4. **前提条件** 「stash」を選択、**操作** 実行、**期待結果** 変更がstashされ、ワーキングディレクトリがクリーンになる
5. **前提条件** 「discard」を選択、**操作** 確認画面で承認、**期待結果** すべての変更が破棄される
6. **前提条件** リリースブランチで変更あり、**操作** AIツールを終了、**期待結果** 自動的にコミットされ、リリースアクション選択が表示される

---

### エッジケース

- **Gitリポジトリでない場所で実行**: エラーメッセージを表示し、Gitリポジトリであることを確認するよう指示する
- **ワークツリーディレクトリから実行**: 警告を表示し、メインリポジトリルートから実行することを推奨する。ユーザーが継続を選択した場合は実行を許可するが、一部の操作が正しく動作しない可能性を警告する
- **AIツールがインストールされていない**: 利用可能なツールがない場合、エラーメッセージとインストール手順URLを表示する
- **GitHub CLI未認証**: PR関連機能を使用しようとした場合、認証状態を確認し、未認証の場合は認証手順を案内する
- **ブランチ名の衝突**: 既に存在するブランチ名で新規作成を試みた場合、エラーを表示し、メインメニューに戻るか選択させる
- **ワークツリーパスの衝突**: 既に存在するパスにワークツリーを作成しようとした場合、別のパスを生成するか確認する
- **ネットワーク障害**: リモート操作（fetch, push, GitHub CLI呼び出し）でネットワークエラーが発生した場合、エラーメッセージを表示し、リトライまたはスキップのオプションを提供する
- **未プッシュのコミットがあるブランチの削除**: 警告を表示し、プッシュするかスキップするか選択させる
- **アクセス不可能なワークツリー**: 別の環境で作成されたワークツリーレコードがある場合、特別な強制削除オプションを提供する
- **package.jsonがないプロジェクトでリリースブランチ**: バージョン更新をスキップし、通常のブランチとして扱う

## 要件

### 機能要件

#### ブランチとワークツリー管理

- **FR-001**: システムは、ローカルおよびリモートのGitブランチをテーブル形式で一覧表示しなければならない
- **FR-002**: システムは、選択したブランチに対してワークツリーの存在を確認し、存在しない場合は自動的に作成パスを生成しなければならない
- **FR-003**: システムは、feature/hotfix/releaseの3種類のブランチタイプを使用した新規ブランチ作成機能を提供しなければならない
- **FR-004**: システムは、ブランチ名に自動的にタイプ別のプレフィックス（feature/、hotfix/、release/）を付与しなければならない
- **FR-005**: システムは、ベースブランチを選択して新規ブランチを作成できなければならない
- **FR-006**: システムは、既存のワークツリーを一覧表示し、選択して開く、削除する機能を提供しなければならない
- **FR-007**: システムは、ワークツリーとブランチを個別または一括で削除できなければならない

#### AIツール統合

- **FR-008**: システムは、Claude Code と Codex CLI の両方をサポートし、対話的または`--tool`オプションで選択できなければならない
- **FR-009**: システムは、選択したワークツリーディレクトリでAIツールを起動しなければならない
- **FR-010**: システムは、AIツールの実行モード（通常、resume、continue）を選択できなければならない
- **FR-011**: システムは、Claude Codeの権限設定をスキップするオプションを提供しなければならない
- **FR-012**: システムは、`--`以降の引数をAIツールに直接パススルーしなければならない

#### セッション管理

- **FR-013**: システムは、最後に使用したワークツリーとブランチをセッションとして保存しなければならない
- **FR-014**: システムは、`-c`オプションで最後のセッションを自動継続しなければならない
- **FR-015**: システムは、`-r`オプションで複数のセッション履歴から選択して復元できなければならない
- **FR-016**: システムは、セッション復元時にワークツリーの存在を確認し、存在しない場合は警告を表示しなければならない

#### GitHub統合

- **FR-017**: システムは、GitHub CLIを使用してマージ済みPRを検出しなければならない
- **FR-018**: システムは、マージ済みPRに対応するブランチとワークツリー、またはベースブランチとの差分が存在しないローカルブランチ／ワークツリーを自動検出しなければならない
- **FR-019**: システムは、ブランチ一覧画面で `c` キーが押下されたときに、検出した全ターゲットを即時に自動処理キューへ登録し、処理中の行はスピナー（例: `⠋`）、待機中の行は `⏳` アイコンに差し替えなければならない。
- **FR-020**: システムは、各ターゲットの処理完了時に `✅`（完了）・`⏭️/⚠️`（スキップ）・`❌`（失敗）などのアイコンを対象行へ表示し、全ターゲットの処理完了後も3秒間その結果を保持しなければならない。
- **FR-021**: システムは、3秒経過後に通常のカーソル表示へ復帰し、削除に成功したブランチ行を一覧から除去するとともに統計情報を更新しなければならない。
- **FR-022**: システムは、クリーンアップ処理中はユーザー入力を受け付けず、フッター直上に `Processing...` とスピナーを表示して進捗を示さなければならない。

#### リリース管理

- **FR-023**: システムは、releaseブランチ作成時にバージョンバンプタイプ（major/minor/patch）を選択できなければならない
- **FR-024**: システムは、package.jsonから現在のバージョンを読み取り、新しいバージョンを計算しなければならない
- **FR-025**: システムは、releaseブランチのワークツリーでpackage.jsonのバージョンを自動更新しなければならない
- **FR-026**: システムは、リリース作業完了時にリリースアクション（complete/continue/nothing）を選択できなければならない
- **FR-027**: システムは、「complete」選択時にブランチをプッシュし、mainブランチへのPRを自動作成しなければならない
- **FR-028**: システムは、PR作成後にタグ作成とdevelopへのマージバック手順を表示しなければならない

#### 変更管理

- **FR-029**: システムは、AIツール終了後に未コミットの変更を検出しなければならない
- **FR-030**: システムは、変更に対してcommit/stash/discard/continueのアクションを選択できなければならない
- **FR-031**: システムは、commitアクション選択時にコミットメッセージを入力できなければならない
- **FR-032**: システムは、discardアクション前に確認を求めなければならない
- **FR-033**: システムは、リリースブランチの変更を自動的にコミットしなければならない

#### ユーザーインターフェース

- **FR-034**: システムは、すべての対話的操作でキャンセル（Ctrl+C、ESC）を適切にハンドリングしなければならない
- **FR-035**: システムは、エラーメッセージ、成功メッセージ、情報メッセージを視覚的に区別して表示しなければならない
- **FR-036**: システムは、ブランチとワークツリーの統計情報（総数）をリアルタイム表示しなければならない
- **FR-036**: システムは、ヘルプメッセージ（-h、--help）を表示できなければならない

#### Codex CLI起動設定

- **FR-037**: システムは、Codex CLIを`bunx @openai/codex@latest`で起動する際に、次の引数を常に付与しなければならない：`-c web_search_request=true`、`--model="gpt-5-codex"`、`--sandbox workspace-write`、`-c model_reasoning_effort="high"`、`-c model_reasoning_summaries="detailed"`、`-c sandbox_workspace_write.network_access=true`、`-c shell_environment_policy.inherit=all`、`-c shell_environment_policy.ignore_default_excludes=true`、`-c shell_environment_policy.experimental_use_profile=true`

### 主要エンティティ

- **ブランチ（Branch）**: Gitブランチを表し、名前、タイプ（local/remote）、ブランチタイプ（feature/hotfix/release/other）、現在のブランチかどうかの属性を持つ
- **ワークツリー（Worktree）**: Git worktreeを表し、ブランチ名、パス、アクセス可能性の属性を持つ
- **セッション（Session）**: 開発セッションを表し、最後のワークツリーパス、ブランチ名、タイムスタンプ、リポジトリルートの属性を持つ
- **クリーンアップ対象（CleanupTarget）**: マージ済みPRやベースブランチとの差分が存在しないローカルブランチ／ワークツリーを表し、ブランチ名、ワークツリーパス、PR情報（存在しない場合はnull）、未コミット／未プッシュ状態、リモートブランチの有無、クリーンアップタイプ（worktree-and-branch/branch-only）、検出理由（merged-pr / no-diff-with-base）の属性を持つ
- **AIツール設定（AI Tool Config）**: AIツール起動設定を表し、ツールタイプ（claude/codex）、実行モード（normal/resume/continue）、権限スキップフラグ、追加引数の属性を持つ

## 成功基準

### 測定可能な成果

- **SC-001**: 開発者は5秒以内にブランチを選択し、ワークツリーでAIツールを起動できる
- **SC-002**: 新規ブランチ作成からワークツリーでの作業開始まで10秒以内で完了できる
- **SC-003**: 最後のセッション継続（`-c`オプション）は3秒以内で再開できる
- **SC-004**: 10個のマージ済みPRブランチを1分以内で一括クリーンアップできる
- **SC-005**: リリースブランチ作成からPR作成まで2分以内で完了できる
- **SC-006**: エラーが発生した場合、ユーザーは明確なエラーメッセージと次のアクションを理解できる
- **SC-007**: 初回ユーザーがヘルプメッセージを読んで基本的な使用方法を理解できる

## 制約と仮定

### 制約

- Bun 1.0.0以上がインストールされている必要がある
- Gitコマンドラインツールがインストールされ、PATHに含まれている必要がある
- AIツール（Claude Code / Codex CLI）のいずれか一方がインストールされている必要がある
- GitHub統合機能はGitHub CLIのインストールと認証が必要
- リリース管理機能はpackage.jsonの存在を前提とする
- ワークツリー機能はGit 2.5以降でサポートされている

### 仮定

- ユーザーはGitの基本的な操作（ブランチ、コミット、プッシュ）を理解している
- リポジトリは既にGitで初期化されている
- リモートリポジトリが設定されている（GitHub統合を使用する場合）
- ユーザーはターミナル/コマンドラインインターフェースの使用に慣れている
- developブランチはGit Flowを採用しているプロジェクトでのみ存在する（オプション）
- ワークツリーは親リポジトリと同じレベルのディレクトリに作成される（例: `../worktree-{branch-name}`）

## 範囲外

次の項目は、この機能の範囲外です：

- GUI（グラフィカルユーザーインターフェース）版の提供
- Git以外のバージョン管理システムのサポート
- ワークツリー内でのファイル編集機能
- コードレビュー機能
- CI/CD統合
- 自動テスト実行
- コード品質チェック（linting、formatting）
- GitLab、Bitbucketなど他のGitホスティングサービスとの統合
- マルチリポジトリ管理（モノレポ以外）
- Gitフックの管理
- コミットメッセージテンプレート管理
- ブランチ保護ルールの設定

## セキュリティとプライバシーの考慮事項

- GitHub認証情報はGitHub CLIによって管理され、本ツールは保存しない
- セッション情報（ワークツリーパス、ブランチ名）は各リポジトリのルートディレクトリの`.config`フォルダに保存される
- ユーザーの同意なしにリモートリポジトリへの変更（push、branch削除）を行わない
- 破壊的操作（discard、branch削除）には必ず確認プロンプトを表示する
- APIキーやシークレットをログに出力しない

## 依存関係

### 外部ツール依存

- **Git**: すべてのGit操作に必要
- **Claude Code**: AIツール統合に必要（オプション）
- **Codex CLI**: AIツール統合に必要（オプション）
- **GitHub CLI（gh）**: GitHub統合機能に必要（オプション）

### npmパッケージ依存
（npm経由で提供されるパッケージ。Bun環境で実行）
- **@inquirer/prompts**: 対話型プロンプトの提供
- **chalk**: コンソール出力の色付け
- **execa**: 外部コマンド実行
- **string-width**: テーブル表示の幅計算

## 参考資料

- プロジェクトリポジトリ: [https://github.com/akiojin/claude-worktree](https://github.com/akiojin/claude-worktree)
- README.md: 使用方法とインストール手順
- Git Worktree ドキュメント: [https://git-scm.com/docs/git-worktree](https://git-scm.com/docs/git-worktree)
- Git Flow: [https://nvie.com/posts/a-successful-git-branching-model/](https://nvie.com/posts/a-successful-git-branching-model/)
- Claude Code: [https://claude.ai/code](https://claude.ai/code)
- GitHub CLI: [https://cli.github.com/](https://cli.github.com/)
