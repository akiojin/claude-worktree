# 機能仕様: ブランチ選択カーソル視認性向上

**仕様ID**: `SPEC-822a2cbf`
**作成日**: 2025-10-25
**ステータス**: ドラフト
**入力**: ユーザー説明: "メイン画面のブランチ選択で、現在のカーソル位置が視認しづらいため、視覚的に分かりやすい選択状態表示を追加する"

## ユーザーシナリオとテスト _(必須)_

### ユーザーストーリー 1 - 誤操作なくブランチを選びたい (優先度: P1)

日常的に worktree 管理を行う開発者として、上下キーでブランチ一覧を移動した際に、現在フォーカスしている行が一目で分かるようにしたい。そうすれば、誤って別ブランチをチェックアウトするリスクを避けられる。

**この優先度の理由**: 誤ったブランチを選択すると作業中の変更を破棄する恐れがあり、最小限の UI 改善で高いリスクを低減できるため。

**独立したテスト**: ブランチ一覧表示中に上下キーを押下し、選択行の視覚的強調が即時に更新されるか、かつ Enter を押下する前に強調表示だけで対象ブランチを特定できるかを確認する。

**受け入れシナリオ**:

1. **前提条件** ブランチ一覧が表示されている、**操作** 上下キーで別のブランチに移動する、**期待結果** 選択行が背景色で反転し、先頭のアイコン列（種別／ワークツリー／変更状態）がずれることなく表示される。
2. **前提条件** ブランチを決定する直前、**操作** Enter を押す前に視認確認する、**期待結果** アイコンと行色のみでブランチ種別・ワークツリー有無・変更有無を識別でき、追加のスクロールや確認操作を要さない。
3. **前提条件** ブランチ一覧に複数の同系統名称（例: `feature/login`, `feature/login-ui`）が並ぶ、**操作** 上下キーで対象ブランチを探す、**期待結果** アイコン列が固定幅のため、ブランチ名が同じ位置から始まり識別しやすい。

---

### ユーザーストーリー 2 - 低コントラスト環境でも判別したい (優先度: P2)

暗いテーマや低輝度のターミナルを使用する開発者として、カラー表示が薄くても選択状態が別の視覚的手掛かりで判断できるようにしたい。そうすれば、外部モニターやリモート環境でも誤選択を防げる。

**この優先度の理由**: 利用環境によって配色が見えづらいケースが一定数あるため、色以外の手掛かりを用意する必要がある。

**独立したテスト**: ターミナルの配色を低コントラスト設定に調整し、背景色が弱い場合でもシンプルなテキスト指標（例: `>`（スペース付き） プレフィックス）で選択行を特定できるかを確認する。

**受け入れシナリオ**:

1. **前提条件** ターミナルがモノクロ表示に設定されている、**操作** 上下キーでブランチを移動する、**期待結果** 背景色が利用できなくても `>`（スペース付き） プレフィックスが付与され、アイコン列とブランチ名の配置は崩れない。
2. **前提条件** スクロール量が多いリポジトリ、**操作** 画面を高速で上下移動する、**期待結果** 強調表示が残像なく更新され、スクロール後も選択行を見失わない。

---

### ユーザーストーリー 3 - ナビゲーション操作を学習したい (優先度: P3)

初めてツールを使う開発者として、選択状態の見分け方とショートカットの使い方を画面内で自然に理解したい。そうすれば、説明書を読まなくても安全に操作を始められる。

**この優先度の理由**: 初回利用者の学習コストを下げ、誤操作による離脱を減らすため。

**独立したテスト**: 初回利用ユーザーに画面だけを見てもらい、選択状態の強調とショートカット説明から操作手順を理解できるかを観察する。

**受け入れシナリオ**:

1. **前提条件** 初回起動直後、**操作** 画面上部のアクションガイダンスを確認する、**期待結果** 選択状態の強調は画面表示だけで理解でき、追加の説明文がなくても操作を開始できる。
2. **前提条件** 選択中にショートカットキー（例: `n`, `m`, `c`）を入力する、**操作** ショートカット処理後にブランチ選択画面へ戻る、**期待結果** 直前に強調表示していた行が再び強調表示され、コンテキストを見失わない。

### エッジケース

- ターミナルが ANSI カラーをサポートしない、または配色がカスタムテーマで極端に淡い場合でも、`>`（スペース付き） などの文字ベースの指標で選択状態が区別できる必要がある。
- 見出しや区切り行など選択できない行にフォーカスが当たらないこと、および強調表示が誤って適用されないこと。
- ブランチの再取得やフィルタリングでリストが再生成された際、強調表示が存在しないブランチを指さないように安全な初期位置へフォールバックすること。

## 要件 _(必須)_

### 機能要件

- **FR-001**: 各行は「ブランチ種別アイコン」「ワークツリーアイコン枠」「変更状態アイコン枠」「配置インジケータ枠」「ブランチ名」の順で表示し、枠幅は固定で揃えた上でブランチ名の開始位置を統一する。配置インジケータはリモートのみ残るブランチで雲アイコン（例: `☁`）を表示し、ローカルが存在する場合は空白を維持する。リモートブランチ名は `origin/` などのプレフィックスを取り除いた名称を表示する。
- **FR-002**: ブランチ種別アイコンは種別に応じた固定絵文字（例: ⚡/✨/🔥/📦/📌/🌿 等）を表示し、ワークツリーアイコンは 🟢（存在・アクセス可）、🟠（存在・アクセス不可）、空欄（存在なし）のいずれかで表現しなければならない。
- **FR-003**: 変更状態アイコンは ✏️（未コミットあり）、⚠️（警告／異常）、⭐（現在ブランチ）、空欄（なし）のいずれかを表示し、同じく固定幅を維持しなければならない。
- **FR-004**: ブランチ名自体は白（既定色）で表示し、配置インジケータ枠はローカルが存在する場合は空白、リモートのみの場合は雲アイコン（例: `☁`）を表示する。カラーが利用できない環境では `>`（スペース付き） プレフィックスで選択行のみを強調し、他行はスペースで揃えなければならない。
- **FR-005**: 上下キーで選択行が変わった際、背景色（またはプレフィックス）による強調は 200ms 以内に更新され、アイコン枠やブランチ名の整列が崩れてはならない。
- **FR-006**: ショートカット遷移後にブランチ一覧へ戻った場合、直前の選択行が再度強調され、行の配列（アイコン・ブランチ名）も元のフォーマットを保つこと。

### 主要エンティティ _(機能がデータを含む場合は含める)_

- **ブランチ一覧表示**: ターミナル上でスクロール可能なブランチ候補の集合。各行がブランチ名と付随情報を持ち、選択状態に応じて強調が切り替わる。
- **選択状態インジケーター**: 現在フォーカスされている行に適用される視覚的表現。標準では背景色で行全体を反転し、カラー非対応環境では `>`（スペース付き） プレフィックスで代替する。アイコン枠とブランチ名の開始位置は常に固定される。

## 成功基準 _(必須)_

### 測定可能な成果

- **SC-001**: ユーザーテストで上下キー操作後 1 秒以内に 95% の参加者が選択中ブランチを正しく指差せる。
- **SC-002**: モノクロ端末で 5 回以上ブランチを移動するテストを実施し、誤選択率が 2% 未満に抑えられる。
- **SC-003**: 初回利用者ヒューリスティック評価で、画面表示のみを見ながらショートカット操作を完遂できる参加者が 90% 以上となる。
- **SC-004**: 回帰テストでショートカット遷移後に強調表示が消失する不具合が再現されない。

## 制約と仮定 _(該当する場合)_

### 制約

- CLI ベースの UI として、追加の外部ツールや GUI を要求しないこと。
- 既存のブランチ一覧レイアウトを大幅に変更せず、横幅 80 文字程度の端末でも崩れないこと。

### 仮定

- 利用者は ANSI カラー対応端末を主に使用するが、一部でモノクロまたは低コントラスト環境が存在すると想定する。
- ブランチ一覧のデータ構造および取得手順は既存機能を流用できる。

## 範囲外 _(必須)_

次の項目は、この機能の範囲外です：

- ブランチ一覧の並び順やフィルタリングロジックの変更。
- ブランチ以外のメニュー（ワークツリー管理、クリーンアップ機能など）の UI 改修。
- 視覚障害者向けスクリーンリーダー連携など音声出力の新規実装。

## セキュリティとプライバシーの考慮事項 _(該当する場合)_

- UI の強調表示のみを変更するため、新たなセキュリティ・プライバシー影響は想定していない。
- ログ出力や診断情報にブランチ名以外の追加情報を記録しない。

## 依存関係 _(該当する場合)_

- 既存の対話型 CLI コンポーネントとショートカット設計。
- プロジェクト内で定義されたブランチメタデータ（種別、説明文など）。

## 参考資料 _(該当する場合)_

- [CLI 操作ガイド (README.ja.md)](../README.ja.md)
- [既存の仕様書群 (specs ディレクトリ)](..)
