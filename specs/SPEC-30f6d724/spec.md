# 機能仕様: カスタムAIツール対応機能

**仕様ID**: `SPEC-30f6d724`
**作成日**: 2025-10-28
**ステータス**: ドラフト
**入力**: ユーザー説明: "カスタムAIツール対応機能"

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - カスタムAIツールの設定 (優先度: P1)

開発者が`~/.claude-worktree/tools.json`ファイルを作成・編集して、独自のAIツール（Claude Code/Codex CLI以外）を登録できる。設定ファイルには、ツールの実行方法（絶対パス、bunx、コマンド名）、デフォルト引数、モード別引数（normal/continue/resume）、権限スキップ引数、環境変数を定義できる。

**この優先度の理由**: これがないとカスタムツールを登録できず、機能全体が使えない。最も基本的な要件。

**独立したテスト**: 設定ファイルを作成し、ツール定義を記述することで完全にテストでき、設定の読み込みと検証機能を提供します。

**受け入れシナリオ**:

1. **前提条件** ユーザーが`~/.claude-worktree/`ディレクトリに書き込み権限を持つ、**操作** `tools.json`ファイルを作成して有効なツール定義を記述する、**期待結果** ファイルが正常に保存され、次回起動時に読み込まれる
2. **前提条件** `tools.json`に構文エラーがある、**操作** claude-worktreeを起動する、**期待結果** わかりやすいエラーメッセージが表示され、エラー箇所が特定できる
3. **前提条件** `tools.json`が存在しない、**操作** claude-worktreeを起動する、**期待結果** ビルトインツール（Claude Code, Codex CLI）のみが表示され、正常に動作する

---

### ユーザーストーリー 2 - カスタムツールの選択と起動 (優先度: P1)

ユーザーがclaude-worktreeを起動し、AIツール選択画面でカスタムツールを選択して起動できる。選択したツールは、設定ファイルで定義された実行方式（path/bunx/command）に従って起動され、デフォルト引数とモード別引数が適切に渡される。

**この優先度の理由**: カスタムツールを実際に使用するための中核機能。P1として設定と同等に重要。

**独立したテスト**: 設定ファイルに1つのカスタムツールを定義し、AIツール選択画面から選択・起動することで完全にテストでき、カスタムツールの実行機能を提供します。

**受け入れシナリオ**:

1. **前提条件** `tools.json`にカスタムツールが登録されている、**操作** AIツール選択画面でカスタムツールを選択する、**期待結果** ビルトインツールと同じように一覧に表示され、選択できる
2. **前提条件** `type: 'path'`のカスタムツールを選択、**操作** normalモードで起動する、**期待結果** 絶対パスで直接実行され、defaultArgs + modeArgs.normal + extraArgsが渡される
3. **前提条件** `type: 'bunx'`のカスタムツールを選択、**操作** continueモードで起動する、**期待結果** bunx経由でパッケージが実行され、defaultArgs + modeArgs.continue + extraArgsが渡される
4. **前提条件** `type: 'command'`のカスタムツールを選択、**操作** resumeモードで起動する、**期待結果** PATH環境変数から探して実行され、defaultArgs + modeArgs.resume + extraArgsが渡される

---

### ユーザーストーリー 3 - 実行モードと権限スキップ (優先度: P2)

ユーザーがカスタムツール起動時に実行モード（normal/continue/resume）を選択し、必要に応じて権限スキップオプションを有効化できる。権限スキップが有効な場合、設定ファイルの`permissionSkipArgs`で定義された引数が追加される。

**この優先度の理由**: 基本的な起動（P1）の次に重要な機能。ユーザー体験の向上に寄与。

**独立したテスト**: 実行モード選択画面で各モードを選択し、権限スキップオプションを切り替えることで完全にテストでき、柔軟な起動オプション機能を提供します。

**受け入れシナリオ**:

1. **前提条件** カスタムツールを選択済み、**操作** 実行モード選択画面でnormalモードを選択、**期待結果** modeArgs.normalに定義された引数が使用される
2. **前提条件** カスタムツールを選択済み、**操作** 権限スキップオプションを有効化、**期待結果** permissionSkipArgsに定義された引数が追加される
3. **前提条件** `permissionSkipArgs`が未定義のツールを選択、**操作** 権限スキップオプションを有効化、**期待結果** エラーなく動作し、permissionSkipArgsは追加されない

---

### ユーザーストーリー 4 - 環境変数の設定 (優先度: P3)

カスタムツール起動時に、設定ファイルの`env`フィールドで定義された環境変数が設定される。これにより、ツール固有の設定（APIキー、設定パスなど）を環境変数経由で渡せる。

**この優先度の理由**: 高度な使用ケース向けの機能。基本的な起動には必須ではない。

**独立したテスト**: envフィールドに環境変数を定義し、ツール起動後に環境変数が設定されていることを確認することで完全にテストでき、ツール固有の環境設定機能を提供します。

**受け入れシナリオ**:

1. **前提条件** `env: {"MY_API_KEY": "xxx"}`を定義したツールを選択、**操作** ツールを起動する、**期待結果** ツールプロセスで`MY_API_KEY`環境変数が利用可能
2. **前提条件** `env`フィールドが未定義のツールを選択、**操作** ツールを起動する、**期待結果** エラーなく動作し、親プロセスの環境変数が継承される

---

### ユーザーストーリー 5 - セッション管理とツール情報の保存 (優先度: P3)

最後に使用したカスタムツールのIDがセッションに保存され、次回起動時に復元される。これにより、同じワークツリーで継続作業する際のツール選択が簡素化される。

**この優先度の理由**: ユーザビリティ向上のための機能。基本機能が動作していれば必須ではない。

**独立したテスト**: カスタムツールで作業し、セッションを終了後に再起動することで完全にテストでき、作業継続性の向上を提供します。

**受け入れシナリオ**:

1. **前提条件** カスタムツールでワークツリーを使用、**操作** ツールを終了してclaude-worktreeを再起動、**期待結果** 前回使用したカスタムツールIDがセッションから読み込まれる
2. **前提条件** セッションファイルにツールIDが保存されている、**操作** そのツールIDの定義が`tools.json`から削除された状態で起動、**期待結果** エラーなく動作し、利用可能なツールのみが表示される

---

### エッジケース

- カスタムツールのコマンドパスが存在しない場合、起動時に明確なエラーメッセージを表示する
- `type: 'command'`のツールがPATH環境変数で見つからない場合、エラーメッセージでコマンド名を表示する
- 同じidを持つ複数のツール定義がある場合、設定ファイル読み込み時にエラーを表示する
- ツール実行中にクラッシュした場合、次回起動時にセッション情報が破損していないことを保証する
- 非常に長いdefaultArgs配列を定義した場合、コマンドライン長制限に達しないよう警告する

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムは`~/.claude-worktree/tools.json`から設定を読み込み、JSONパースエラー時にエラーメッセージを表示**しなければならない**
- **FR-002**: システムは各CustomAITool定義の必須フィールド（id, displayName, type, command, modeArgs）の存在を検証**しなければならない**
- **FR-003**: システムはtypeフィールドが`'path'`、`'bunx'`、`'command'`のいずれかであることを検証**しなければならない**
- **FR-004**: システムは同一id値の重複を検出し、エラーを表示**しなければならない**
- **FR-005**: システムはビルトインツール（Claude Code, Codex CLI）とカスタムツールを統合した一覧を返す`getAllTools()`関数を提供**しなければならない**
- **FR-006**: システムは`tools.json`が存在しない場合、ビルトインツールのみを表示して正常動作**しなければならない**
- **FR-007**: システムは`type: 'path'`のツールを絶対パスで直接実行**しなければならない**
- **FR-008**: システムは`type: 'bunx'`のツールをbunx経由で実行**しなければならない**
- **FR-009**: システムは`type: 'command'`のツールをPATH環境変数から解決して実行**しなければならない**
- **FR-010**: システムは引数を`defaultArgs + modeArgs[mode] + permissionSkipArgs（条件付き） + extraArgs`の順で結合**しなければならない**
- **FR-011**: システムはツール起動時に`env`フィールドで定義された環境変数を設定**しなければならない**
- **FR-012**: AIToolSelectorScreenはカスタムツールをビルトインツールと同じUI形式で表示**しなければならない**
- **FR-013**: システムはSessionDataに`lastUsedTool`フィールドを追加し、最後に使用したツールIDを保存**しなければならない**
- **FR-014**: システムはセッション復元時にツールID情報を読み込み、利用可能なツール一覧に反映**しなければならない**
- **FR-015**: システムは実行モード選択画面でツール別の権限スキップオプション表示に対応**しなければならない**

### 主要エンティティ

- **ToolsConfig**: 設定ファイル全体を表すエンティティ。`version`（文字列）と`customTools`（CustomAIToolの配列）を持つ
- **CustomAITool**: カスタムツールの定義。`id`（一意識別子）、`displayName`（UI表示名）、`icon`（オプション）、`type`（実行方式: path/bunx/command）、`command`（実行パス/パッケージ名/コマンド名）、`defaultArgs`（デフォルト引数配列、オプション）、`modeArgs`（normal/continue/resumeの各モード別引数を持つオブジェクト）、`permissionSkipArgs`（権限スキップ時の引数配列、オプション）、`env`（環境変数のキー・バリューペア、オプション）を持つ
- **SessionData**: セッション情報。既存フィールドに加えて`lastUsedTool`（最後に使用したツールID、オプション）を持つ

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: ユーザーは設定ファイルを作成してカスタムツールを登録し、30秒以内に起動できる
- **SC-002**: システムは設定ファイルのJSON構文エラーを100%検出し、エラー箇所を特定できる
- **SC-003**: カスタムツールの起動成功率が95%以上（設定が正しい場合）
- **SC-004**: 3種類すべての実行方式（path/bunx/command）が期待通りに動作する
- **SC-005**: ビルトインツールの既存動作が100%維持される（後方互換性）
- **SC-006**: セッション復元時にツール情報が正確に復元される成功率が100%

## 制約と仮定 *(該当する場合)*

### 制約

- bunx実行環境が必須（既存のclaude-worktreeがbunベースのため）
- ユーザーは`~/.claude-worktree/`ディレクトリへの書き込み権限を持つ
- 設定ファイルは手動編集が必要（GUIエディタは範囲外）
- 既存のClaude Code/Codex CLI起動ロジックと互換性を維持する

### 仮定

- ユーザーは有効なJSON形式で設定ファイルを記述できる
- カスタムツールの実行ファイル/パッケージは事前にインストール済み
- PATH環境変数は適切に設定されている（`type: 'command'`の場合）
- ツール実行に必要な環境変数（APIキーなど）はユーザーが管理する

## 範囲外 *(必須)*

次の項目は、この機能の範囲外です：

- GUIベースの設定エディタ（設定ファイルは手動編集のみ）
- カスタムツールのインストール機能（ユーザーが手動でインストール）
- ツール設定の自動検出・自動生成
- ツール間の依存関係管理
- ツールのバージョン管理
- ツールの自動更新機能
- 設定ファイルのクラウド同期

## セキュリティとプライバシーの考慮事項 *(該当する場合)*

- 設定ファイルに記述された環境変数（APIキーなど）は平文保存されるため、ファイルパーミッションを適切に設定する必要がある
- `type: 'path'`で絶対パス実行する際、パスインジェクション攻撃のリスクがあるため、パス検証を実施する
- `type: 'command'`でPATH環境変数から探す際、意図しないコマンドが実行されるリスクがあるため、which/whereコマンドの結果を確認する
- ツール実行時に渡される引数に機密情報が含まれる可能性があるため、ログ出力時にマスキングを検討する

## 依存関係 *(該当する場合)*

- bunx（カスタムツールのパッケージ実行に必要）
- 既存のclaude-worktree設定システム（`src/config/index.ts`）
- 既存のセッション管理機能（セッション保存・復元）
- 既存のAIツール起動ロジック（`src/claude.ts`, `src/codex.ts`）
- 既存のUI components（AIToolSelectorScreen, ExecutionModeSelectorScreen）

## 参考資料 *(該当する場合)*

- [既存のCodex CLI実装](../../src/codex.ts)（デフォルト引数の実装例）
- [既存のClaude Code実装](../../src/claude.ts)（モード別起動の実装例）
- [既存の設定管理実装](../../src/config/index.ts)（設定ファイル読み込みの実装例）
