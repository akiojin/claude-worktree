# 機能仕様: ブランチ作成・選択機能の改善

**仕様ID**: `SPEC-908f506d`
**作成日**: 2025-10-29
**ステータス**: ドラフト
**入力**: ユーザー説明: "ブランチ作成・選択機能の改善"

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - カレントブランチでの直接作業 (優先度: P1)

開発者がブランチ一覧から、現在作業中のブランチ（カレントブランチ）を選択した場合、システムは新しいWorktreeを作成せず、ルートディレクトリでそのままAIツールを起動する。これにより、すでに作業中のブランチで即座に作業を継続できる。

**この優先度の理由**: 既存の不具合修正であり、開発者がカレントブランチで作業を続ける際の無駄なWorktree作成を防ぐため、最優先で対応する必要がある。開発者体験の根本的な改善となる。

**独立したテスト**: カレントブランチを選択するだけでテスト可能。Worktreeが作成されないこと、ルートディレクトリでAIツールが起動することを確認できる。

**受け入れシナリオ**:

1. **前提条件** ユーザーがルートディレクトリのブランチ（例：develop）で作業中、**操作** ブランチ一覧からカレントブランチを選択、**期待結果** Worktreeが作成されず、ルートディレクトリでAIツールが起動される
2. **前提条件** ユーザーがルートディレクトリのブランチで作業中、**操作** 別のブランチを選択、**期待結果** 通常通りWorktreeが作成または再利用される

---

### ユーザーストーリー 2 - 既存ブランチでの作業継続 (優先度: P2)

開発者がブランチ一覧から任意のブランチを選択した後、「既存ブランチで続行」を選択すると、そのブランチのWorktreeが作成または再利用され、AIツールが起動される。これは現在の標準的な動作を明示的に選択できるようにするもの。

**この優先度の理由**: 新機能の基本動作であり、ユーザーが既存のブランチで作業を開始する際の標準フローとなる。P1の次に重要。

**独立したテスト**: ブランチ選択後、アクション選択画面で「既存ブランチで続行」を選択することでテスト可能。Worktreeが作成/再利用され、AIツールが起動することを確認できる。

**受け入れシナリオ**:

1. **前提条件** ユーザーがブランチ一覧を表示中、**操作** ブランチを選択し「既存ブランチで続行」を選ぶ、**期待結果** 選択したブランチのWorktreeが作成または再利用され、AIツールが起動される
2. **前提条件** 選択したブランチのWorktreeが既に存在する、**操作** 「既存ブランチで続行」を選択、**期待結果** 既存のWorktreeが再利用される

---

### ユーザーストーリー 3 - 選択ブランチをベースに新規ブランチ作成 (優先度: P3)

開発者がブランチ一覧から任意のブランチを選択した後、「新規ブランチを作成」を選択すると、選択したブランチをベースとして新しいブランチを作成できる。新規ブランチのタイプ（feature/hotfix/release）と名前を入力し、そのWorktreeが作成されてAIツールが起動される。

**この優先度の理由**: 追加機能であり、開発フローの柔軟性を高めるが、基本動作ではないため優先度は低い。

**独立したテスト**: ブランチ選択後、アクション選択画面で「新規ブランチを作成」を選択し、ブランチ作成フローを完了することでテスト可能。選択したブランチがベースとして使用されることを確認できる。

**受け入れシナリオ**:

1. **前提条件** ユーザーがブランチ一覧からブランチ（例：develop）を選択、**操作** 「新規ブランチを作成」を選び、ブランチタイプと名前を入力、**期待結果** 選択したブランチ（develop）をベースに新規ブランチが作成され、Worktreeが作成され、AIツールが起動される
2. **前提条件** ユーザーがリモートブランチを選択、**操作** 「新規ブランチを作成」を選択、**期待結果** リモートブランチをベースに新規ブランチが作成される

---

### エッジケース

- カレントブランチのWorktreeが既に別の場所に存在する場合、何が起こりますか？
  → システムは既存のWorktreeを検出し、そのパスを使用する
- ユーザーが新規ブランチ作成時に既存のブランチ名を入力した場合、どうなりますか？
  → システムはエラーメッセージを表示し、別の名前を入力するよう促す
- カレントブランチを判定できない場合（detached HEADなど）、どうなりますか？
  → システムは通常のブランチとして扱い、アクション選択画面を表示する

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムは、ブランチ一覧でブランチを選択した際、そのブランチがカレントブランチかどうかを判定**しなければならない**
- **FR-002**: システムは、カレントブランチが選択された場合、Worktree作成をスキップしてルートディレクトリパスを使用**しなければならない**
- **FR-003**: システムは、カレントブランチ以外のブランチが選択された場合、アクション選択画面を表示**しなければならない**
- **FR-004**: アクション選択画面は「既存ブランチで続行」と「新規ブランチを作成」の2つの選択肢を提示**しなければならない**
- **FR-005**: 「既存ブランチで続行」が選択された場合、システムは選択したブランチのWorktreeを作成または再利用**しなければならない**
- **FR-006**: 「新規ブランチを作成」が選択された場合、システムはブランチ作成画面に遷移し、選択したブランチをベースブランチとして設定**しなければならない**
- **FR-007**: ブランチ作成画面は、ベースブランチ情報を受け取り、そのブランチから新規ブランチを作成**しなければならない**
- **FR-008**: システムは、新規ブランチ作成後、そのWorktreeを作成してAIツールを起動**しなければならない**

### 主要エンティティ

- **ブランチ**: Gitブランチを表し、名前、タイプ（local/remote）、カレント状態（isCurrent）の情報を持つ
- **Worktree**: Git worktreeを表し、ブランチ名、パス、存在状態の情報を持つ
- **アクション**: ブランチ選択後のユーザーアクション（既存使用/新規作成）を表す

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: ユーザーがカレントブランチを選択した場合、Worktree作成処理をスキップし、1秒以内にAIツールが起動される
- **SC-002**: ユーザーがカレントブランチ以外を選択した場合、1秒以内にアクション選択画面が表示される
- **SC-003**: アクション選択画面から「既存ブランチで続行」を選択した場合、3秒以内にWorktreeが作成/再利用されてAIツールが起動される
- **SC-004**: アクション選択画面から「新規ブランチを作成」を選択した場合、ブランチ作成画面が1秒以内に表示され、選択したブランチがベースとして設定されている
- **SC-005**: 開発者の90%が、新しいフローを使用して初回で目的のブランチでの作業を開始できる

## 制約と仮定 *(該当する場合)*

### 制約

- 既存のWorktree管理システムを使用する必要がある
- 既存の画面遷移フロー（Ink.js React）に統合する必要がある

### 仮定

- ユーザーは有効なGitリポジトリで作業している
- カレントブランチは `git branch --show-current` コマンドで取得できる
- ブランチ情報には `isCurrent` フラグが含まれている

## 範囲外 *(必須)*

次の項目は、この機能の範囲外です：

- 複数のブランチから新規ブランチを作成する機能
- ブランチのマージやリベース機能
- Worktreeの削除や管理機能（既存の 'm' キーの機能）
- ベースブランチの手動変更機能

## セキュリティとプライバシーの考慮事項 *(該当する場合)*

- 特になし（ローカル開発環境での操作のみ）

## 依存関係 *(該当する場合)*

- 既存のWorktreeOrchestratorサービス
- 既存のBranchCreatorScreen
- 既存のInk.js UIコンポーネント（Select、画面遷移管理）
- Git コマンド（`git branch --show-current`、`git worktree add`）

## 参考資料 *(該当する場合)*

- 既存のブランチ選択フロー実装: `src/ui/components/App.tsx`
- Worktree作成ロジック: `src/services/WorktreeOrchestrator.ts`
- ブランチ作成画面: `src/ui/components/screens/BranchCreatorScreen.tsx`
