# 実装計画: GitHub Actions リリースワークフローのタグトリガー変更

**仕様ID**: `SPEC-23bb2eed` | **日付**: 2025-10-25 | **仕様書**: [spec.md](./spec.md)
**入力**: `/specs/SPEC-23bb2eed/spec.md` からの機能仕様

**注**: このテンプレートは `/speckit.plan` コマンドによって記入されます。実行ワークフローについては `.specify/templates/commands/plan.md` を参照してください。

## ⚠️ 重要な調査結果

**Phase 0 の調査により、元の要件（タグトリガーへの変更）は技術的に不適切であることが判明しました。**

詳細は [research.md](./research.md) を参照してください。

### 調査結果サマリー

- **semantic-release とタグトリガーは互換性がない**
  - semantic-release 自体がタグを作成するツール
  - タグトリガーで実行すると循環依存が発生
  - 自動バージョニング、CHANGELOG 生成などの機能が喪失

- **推奨アプローチ**: 現状の main ブランチトリガーを維持
  - 既存の自動化機能を完全に維持
  - semantic-release のベストプラクティスに準拠
  - プロジェクトの「シンプルさの極限を追求」原則に整合

**次のステップ**: ユーザーの判断が必要

1. **オプション1（推奨）**: 仕様を変更して現状維持、設定の明示化のみ実施
2. **オプション2（非推奨）**: semantic-release を削除してタグトリガーに移行

## 概要

GitHub Actions のリリースワークフローを main ブランチトリガーから v* タグトリガーへ変更する要件を調査しましたが、技術調査の結果、現在使用している semantic-release ツールとの互換性がないことが判明しました。

**元の要件**: npm version コマンドでタグを作成した時に自動的にリリースワークフローを実行

**調査結果**: semantic-release は main ブランチトリガーで動作するように設計されており、タグトリガーに変更すると自動化機能が失われます。

## 技術コンテキスト

**言語/バージョン**: TypeScript 5.8.3, Node.js 互換（Bun 1.0.0+ 必須）
**主要な依存関係**:

- semantic-release（自動リリースツール）
- Bun（ビルドとテスト実行環境）
- GitHub Actions（CI/CD プラットフォーム）
- Vitest（テストフレームワーク）

**ストレージ**: N/A（設定ファイルのみ）
**テスト**: Vitest（既存のテストスイート）
**ターゲットプラットフォーム**: GitHub Actions（ubuntu-latest）
**プロジェクトタイプ**: CLI ツール（単一プロジェクト）
**パフォーマンス目標**: N/A（ワークフロー設定変更のみ）
**制約**:

- semantic-release との互換性維持が必須
- 既存のリリースプロセス（テスト、ビルド、npm publish）を維持
- Bun 1.0.0+ が必須ランタイム

**スケール/範囲**:

- 変更対象: `.github/workflows/release.yml`（1ファイル）
- 影響範囲: リリースワークフロー全体

## 原則チェック

*ゲート: フェーズ0の調査前に合格する必要があります。フェーズ1の設計後に再チェック。*

### CLAUDE.md との整合性チェック

#### 1. シンプルさの原則

**原則**: "設計・実装は複雑にせずに、シンプルさの極限を追求してください"

**評価**:

- ✅ **現状維持（推奨）**: semantic-release の自動化を維持 = 最もシンプル
- ❌ **タグトリガー移行**: ワークフロー複雑化、手動作業増加 = 複雑化

**結論**: 現状維持が原則に整合

#### 2. ユーザビリティと開発者体験

**原則**: "ただし、ユーザビリティと開発者体験の品質は決して妥協しない"

**評価**:

- ✅ **現状維持（推奨）**: PR マージのみで自動リリース = 最高の開発者体験
- ❌ **タグトリガー移行**: npm version + git push --tags の手動操作 = 体験低下

**結論**: 現状維持が原則に整合

#### 3. 完了条件

**原則**: "エラーが発生している状態で完了としないこと"

**評価**:

- ✅ 調査により技術的課題を発見
- ✅ ユーザーに判断を仰ぐプロセスを実施

**結論**: 原則に準拠

### ゲート評価

**Phase 0 調査前ゲート**: ✅ 合格

- 既存のプロジェクト原則を確認
- 技術的制約を明確化

**Phase 0 調査後ゲート**: ⚠️ ユーザー判断待ち

- 調査結果が元の要件と矛盾
- 仕様変更の判断が必要

## プロジェクト構造

### ドキュメント（この機能）

```text
specs/SPEC-23bb2eed/
├── spec.md                # 機能仕様（/speckit.specify 出力）
├── checklists/
│   └── requirements.md    # 仕様品質チェックリスト（/speckit.specify 出力）
├── research.md            # Phase 0 調査結果（このコマンド出力）✅
├── plan.md                # このファイル（/speckit.plan 出力）✅
├── data-model.md          # Phase 1 出力（判断後）⏭️
├── quickstart.md          # Phase 1 出力（判断後）⏭️
├── contracts/             # Phase 1 出力（判断後）⏭️
└── tasks.md               # Phase 2 出力（/speckit.tasks - 判断後）⏭️
```

### ソースコード（リポジトリルート）

```text
.github/workflows/
├── release.yml            # 変更対象ファイル（現状維持の場合は変更なし）
└── test.yml               # 影響なし

package.json               # semantic-release の依存関係定義
.releaserc.json            # semantic-release 設定（新規作成を推奨）
```

## フェーズ0: 調査（技術スタック選定）

**目的**: 要件に基づいて技術スタックを決定し、既存のコードパターンを理解する

**出力**: ✅ `specs/SPEC-23bb2eed/research.md`

### 調査項目

1. **既存のコードベース分析** ✅
   - 現在の技術スタック: TypeScript, Bun, Vitest, semantic-release
   - 既存のパターン: GitHub Actions + semantic-release の自動リリース
   - 統合ポイント: release.yml ワークフロー

2. **技術的決定** ✅
   - **決定1**: GitHub Actions on.push.tags 構文の調査完了
   - **決定2**: semantic-release とタグトリガーの互換性評価完了
   - **決定3**: 現状維持 vs タグトリガー移行の比較分析完了

3. **制約と依存関係** ✅
   - **制約1**: semantic-release は main ブランチトリガー前提
   - **制約2**: タグトリガーへの変更は自動化機能を喪失

### 調査結果の要約

詳細は [research.md](./research.md) を参照。

**主要な発見**:

- semantic-release とタグトリガーは技術的に互換性がない
- 現状の main ブランチトリガーが最適解
- タグトリガーへの移行は semantic-release の削除を伴う

**推奨**: 仕様を変更して現状維持

## フェーズ1: 設計（アーキテクチャと契約）

**状態**: ⏸️ ユーザーの判断待ち

**ユーザーの選択により、以下のいずれかを実施**:

### オプション1: 現状維持 + 設定明示化（推奨）

**出力**:

- `specs/SPEC-23bb2eed/data-model.md`: semantic-release 設定構造
- `specs/SPEC-23bb2eed/quickstart.md`: リリースプロセスガイド
- `specs/SPEC-23bb2eed/contracts/releaserc-schema.json`: semantic-release 設定スキーマ

**実装内容**:

1. `.releaserc.json` ファイルの作成（デフォルト設定の明示化）
2. README.md へのリリースプロセス記載
3. ブランチプロテクション設定の推奨（ドキュメントのみ）

### オプション2: semantic-release 削除 + タグトリガー移行（非推奨）

**出力**:

- `specs/SPEC-23bb2eed/data-model.md`: タグトリガーワークフロー構造
- `specs/SPEC-23bb2eed/quickstart.md`: 手動リリースプロセスガイド
- `specs/SPEC-23bb2eed/contracts/release-workflow.yml`: 新しいワークフロー定義

**実装内容**:

1. semantic-release の削除
2. release.yml のタグトリガーへの変更
3. GitHub Release 作成ステップの追加
4. CHANGELOG 更新プロセスの文書化

## フェーズ2: タスク生成

**次のステップ**: ユーザーの判断後に `/speckit.tasks` コマンドを実行

**入力**: このプラン + 仕様書 + 設計ドキュメント + ユーザーの決定

**出力**: `specs/SPEC-23bb2eed/tasks.md` - 実装のための実行可能なタスクリスト

## 実装戦略

### オプション1の場合（現状維持 - 推奨）

#### 優先順位付け

1. **P1**: `.releaserc.json` の作成（設定明示化）
2. **P2**: ドキュメント更新（README.md へのリリースプロセス記載）
3. **P3**: ブランチプロテクション設定の推奨事項記載

#### 独立したデリバリー

- 各ステップは独立して実装・テスト可能
- 既存の自動化機能を維持したまま段階的に改善

### オプション2の場合（タグトリガー移行 - 非推奨）

#### 優先順位付け

1. **P1**: semantic-release の削除とワークフロー変更
2. **P2**: GitHub Release 作成ステップの実装
3. **P3**: CHANGELOG 更新プロセスの文書化とツール選定

#### リスク

- 大規模な変更により既存のリリースプロセスが一時的に停止
- ロールバックが困難
- 手動作業の増加によるエラーリスク

## テスト戦略

### オプション1の場合（現状維持）

- **設定ファイルテスト**: `.releaserc.json` の構文検証
- **統合テスト**: semantic-release の動作確認（既存のワークフローで自動実行）
- **ドキュメントテスト**: README.md の記載内容を実際に実行して検証

**カバレッジ**: 既存のテストスイート（122テスト）を維持

### オプション2の場合（タグトリガー移行）

- **ワークフロー構文テスト**: YAML ファイルの構文検証
- **統合テスト**: タグ作成 → ワークフロー実行の E2E テスト
- **ロールバックテスト**: 問題発生時の復旧手順の検証

**カバレッジ**: 新しいリリースプロセスのテストを追加（推定 +10テスト）

## リスクと緩和策

### オプション1の場合（現状維持）

#### 技術的リスク

1. **リスク**: `.releaserc.json` の設定ミス
   - **影響**: semantic-release が正常に動作しない
   - **緩和策**: デフォルト設定を明示的に記載、テスト環境で検証

#### 依存関係リスク

1. **リスク**: semantic-release の破壊的変更
   - **影響**: 将来のバージョンアップで動作しなくなる
   - **緩和策**: バージョンを固定、定期的なアップデートとテスト

### オプション2の場合（タグトリガー移行）

#### 技術的リスク

1. **リスク**: 手動リリースプロセスのヒューマンエラー
   - **影響**: バージョン番号の誤り、CHANGELOG の漏れ
   - **緩和策**: チェックリスト作成、ダブルチェック体制

2. **リスク**: ワークフロー複雑化によるメンテナンス困難
   - **影響**: 将来の変更が困難、バグ修正に時間がかかる
   - **緩和策**: 詳細なドキュメント作成、定期的なレビュー

#### 依存関係リスク

1. **リスク**: npm version コマンドの挙動変更
   - **影響**: タグ生成方法が変わる可能性
   - **緩和策**: バージョン管理ツールの選定、代替案の検討

## 次のステップ

### 現在の状態

1. ✅ Phase 0 完了: 調査と技術スタック決定
2. ⏸️ **ユーザー判断待ち**: オプション1（現状維持）またはオプション2（タグトリガー移行）
3. ⏭️ Phase 1: ユーザーの決定に基づいて設計とアーキテクチャ定義
4. ⏭️ `/speckit.tasks` を実行してタスクを生成
5. ⏭️ `/speckit.implement` で実装を開始

### ユーザーへの質問

以下のいずれかを選択してください:

**オプション1（推奨）**: 現状の main ブランチトリガーを維持

- メリット: 既存の自動化機能を完全に維持、シンプル、信頼性が高い
- デメリット: 元の要件（タグトリガー）を実現できない
- 実装範囲: 最小限（設定の明示化とドキュメント更新のみ）

**オプション2（非推奨）**: semantic-release を削除してタグトリガーに移行

- メリット: 元の要件を完全に実現
- デメリット: 自動化機能の喪失、手動作業の増加、複雑化
- 実装範囲: 大規模（ワークフロー全体の再設計）

**推奨**: オプション1を選択し、現状の自動化機能を維持することを強く推奨します。
