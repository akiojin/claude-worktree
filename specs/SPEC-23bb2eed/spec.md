# 機能仕様: GitHub Actions リリースワークフローのタグトリガー変更

**仕様ID**: `SPEC-23bb2eed`
**作成日**: 2025-10-25
**ステータス**: ドラフト
**入力**: ユーザー説明: "GitHub Actionsのリリースワークフローのトリガー条件を、mainブランチへのプッシュからバージョンタグ（v*パターン）のプッシュに変更する。npm versionコマンドでタグを作成した時に自動的にリリースワークフローが実行されるようにする。"

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - npm versionによる自動リリース実行 (優先度: P1)

開発者として、npm versionコマンドでバージョンタグを作成してプッシュした時に、自動的にリリースワークフローが実行されてほしい。

**この優先度の理由**: バージョン管理とリリースプロセスの自動化は、手動作業のミスを防ぎ、リリースの一貫性を保つために最も重要な機能。

**独立したテスト**: `npm version patch` → `git push --tags` を実行し、GitHub ActionsでRelease workflowが自動実行されることを確認することで完全にテスト可能。

**受け入れシナリオ**:

1. **前提条件** 開発者がローカルでコード変更をコミット済み、**操作** `npm version patch` → `git push --tags` を実行、**期待結果** GitHub Actionsのリリースワークフローが自動的にトリガーされる
2. **前提条件** 開発者がマイナーバージョンアップを実施、**操作** `npm version minor` → `git push --tags` を実行、**期待結果** v*.*.0形式のタグでリリースワークフローが実行される
3. **前提条件** 開発者がメジャーバージョンアップを実施、**操作** `npm version major` → `git push --tags` を実行、**期待結果** v*.0.0形式のタグでリリースワークフローが実行される

---

### ユーザーストーリー 2 - 意図しないリリース防止 (優先度: P2)

開発者として、mainブランチへの通常のプッシュではリリースワークフローがトリガーされないようにしたい。これにより、意図しないリリースを防ぐ。

**この優先度の理由**: リリースは明示的なバージョンタグ作成時のみ実行されるべきであり、通常の開発作業で誤ってリリースが実行されることを防ぐ必要がある。

**独立したテスト**: mainブランチに直接プッシュし、リリースワークフローが実行されないことを確認することで検証可能。

**受け入れシナリオ**:

1. **前提条件** 開発者が機能開発をmainブランチにマージ、**操作** 通常のgit pushを実行、**期待結果** リリースワークフローはトリガーされず、他のワークフロー（テスト、ビルド）のみ実行される
2. **前提条件** 開発者がhotfixをmainブランチに直接プッシュ、**操作** git pushを実行、**期待結果** リリースワークフローは実行されない

---

### ユーザーストーリー 3 - プレリリース版の自動リリース (優先度: P3)

開発者として、プレリリース版（beta、alphaなど）のタグをプッシュした時も、自動的にリリースワークフローが実行されてほしい。

**この優先度の理由**: プレリリース版のリリースプロセスも自動化することで、テストユーザーへの配布を効率化できる。

**独立したテスト**: `npm version prerelease` → `git push --tags` でプレリリースタグを作成し、リリースワークフローが実行されることを確認。

**受け入れシナリオ**:

1. **前提条件** 開発者がbeta版をリリース、**操作** `npm version prerelease --preid=beta` → `git push --tags` を実行、**期待結果** v*.*.*-beta.*形式のタグでリリースワークフローが実行される
2. **前提条件** 開発者がalpha版をリリース、**操作** `npm version prerelease --preid=alpha` → `git push --tags` を実行、**期待結果** v*.*.*-alpha.*形式のタグでリリースワークフローが実行される

---

### エッジケース

- vで始まらないタグ（例: `release-1.0.0`）がプッシュされた場合、リリースワークフローはトリガーされない
- 複数のv*タグが同時にプッシュされた場合、各タグに対してリリースワークフローが個別に実行される
- v接頭辞のみのタグ（例: `v`）がプッシュされた場合の動作は未定義（通常は発生しないシナリオ）

## 要件 *(必須)*

### 機能要件

- **FR-001**: GitHub Actionsリリースワークフローは、v*パターンに一致するタグがプッシュされた時にトリガーされ**なければならない**
- **FR-002**: GitHub Actionsリリースワークフローは、mainブランチへのプッシュではトリガーされ**てはならない**
- **FR-003**: リリースワークフローは、`npm version patch/minor/major` → `git push --tags` のワークフローで正常に動作**しなければならない**
- **FR-004**: リリースワークフローは、プレリリース版タグ（v*.*.*-beta.*、v*.*.*-alpha.*など）でもトリガーされ**なければならない**
- **FR-005**: リリースワークフローのトリガー変更後も、既存のsemantic-releaseとnpm publishプロセスが正常に動作**しなければならない**

### 主要エンティティ

- **バージョンタグ**: v*パターンに一致するGitタグ（例: v1.0.0, v2.1.3-beta.1）。npm versionコマンドで自動生成される。
- **リリースワークフロー**: GitHub Actionsで定義された自動リリースプロセス（`.github/workflows/release.yml`）。semantic-releaseとnpm publishを実行する。

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: v*形式のタグがリポジトリにプッシュされた時、リリースワークフローが自動的に開始される
- **SC-002**: mainブランチへの通常のプッシュ時、リリースワークフローは実行されない
- **SC-003**: npm version → git push --tagsのワークフローで、リリースプロセスが完全に自動化され、手動介入が不要になる
- **SC-004**: 既存のリリースプロセス（semantic-release、npm publish）が変更後も100%の成功率で動作する

## 制約と仮定 *(該当する場合)*

### 制約

- GitHub Actionsワークフローファイル（`.github/workflows/release.yml`）が既に存在すること
- npm versionコマンドがデフォルトでv接頭辞付きタグを生成する設定になっていること

### 仮定

- 開発者はnpm versionコマンドを使用してバージョン管理を行っている
- タグのプッシュは意図的な操作であり、誤ってプッシュされることは少ない
- 既存のsemantic-releaseとnpm publishの設定は適切に構成されている

## 範囲外 *(必須)*

次の項目は、この機能の範囲外です：

- semantic-releaseやnpm publishの設定変更
- package.jsonのバージョン管理方法の変更
- リリースノート生成ロジックの変更
- 他のGitHub Actionsワークフロー（テスト、ビルドなど）のトリガー条件変更

## セキュリティとプライバシーの考慮事項 *(該当する場合)*

- タグのプッシュには適切な権限が必要であり、mainブランチへのプッシュ権限と同等のアクセス制御が適用される
- リリースワークフローはGitHub SecretsのNPM_TOKENとGITHUB_TOKENを使用するため、既存のセキュリティ設定を維持する

## 依存関係 *(該当する場合)*

- GitHub Actions（ワークフロー実行環境）
- npm versionコマンド（バージョンタグ生成）
- semantic-release（自動リリースツール）
- Bun（ビルドとテスト実行環境）

## 参考資料 *(該当する場合)*

- GitHub Actions ワークフロー構文: https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions
- npm version コマンドドキュメント: https://docs.npmjs.com/cli/version
- semantic-release ドキュメント: https://semantic-release.gitbook.io/
