# 機能仕様: UI移行 - Ink.js（React）ベースのCLIインターフェース

**仕様ID**: `SPEC-4c2ef107`
**作成日**: 2025-01-25
**ステータス**: ドラフト
**入力**: ユーザー説明: "UI移行: inquirer/chalkからInk.js（React）への全面移行"

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - ブランチ一覧表示と選択 (優先度: P1)

開発者がclaude-worktreeを起動すると、全画面レイアウトでブランチ一覧が表示される。ヘッダーにはタイトルと統計情報が固定表示され、ブランチリストはスクロール可能で、フッターにはキーボードアクションが常に表示される。開発者はキーボードでスムーズにブランチを選択でき、画面がちらつかずに安定して動作する。

**この優先度の理由**: これはアプリケーションの最も基本的で使用頻度の高い機能であり、すべての操作の起点となるため、最優先で実装する必要がある。

**独立したテスト**: ブランチ一覧画面のレンダリングと選択操作をテストすることで、UIフレームワークの動作と基本的なユーザーインタラクションを検証できる。

**受け入れシナリオ**:

1. **前提条件**: claude-worktreeが正常にインストールされている、**操作**: アプリケーションを起動する、**期待結果**: 1秒以内に全画面レイアウトが表示され、ヘッダー・統計情報・ブランチリスト・フッターがそれぞれの位置に正しく表示される
2. **前提条件**: ブランチが画面に入りきらない数（20個以上）存在する、**操作**: 上下キーでナビゲーションする、**期待結果**: スムーズにスクロールし、選択中の項目が常に表示され、ヘッダーとフッターは固定位置を維持する
3. **前提条件**: ブランチ一覧が表示されている、**操作**: ターミナルウィンドウをリサイズする、**期待結果**: レイアウトが自動的に再計算され、表示可能な行数が調整される
4. **前提条件**: ブランチ一覧が表示されている、**操作**: ブランチを選択してEnterキーを押す、**期待結果**: 選択されたブランチに対する処理が開始される
5. **前提条件**: ブランチ一覧が表示されている、**操作**: qキーを押す、**期待結果**: アプリケーションが正常に終了する
6. **前提条件**: Gitリポジトリの列挙に300ms以上を要する状況である、**操作**: アプリケーションを起動したまま待機する、**期待結果**: 500ms以内にローディングインジケーターが表示され、処理完了時に自動的に通常画面へ切り替わる

---

### ユーザーストーリー 2 - サブ画面のナビゲーション (優先度: P2)

開発者が各種アクション（新規ブランチ作成、Worktree管理、PRクリーンアップ、AIツール選択など）を実行する際、同じ全画面レイアウトパターンで一貫したUIが提供される。画面遷移がスムーズで、戻る操作も直感的に行える。

**この優先度の理由**: 基本機能（P1）の次に重要なユーザー操作であり、既存機能の維持に不可欠。ただし、P1が動作すればMVPとして機能するため、P2とする。

**独立したテスト**: 各サブ画面を個別にテストし、画面遷移ロジックと状態管理を検証できる。

**受け入れシナリオ**:

1. **前提条件**: ブランチ一覧が表示されている、**操作**: nキーを押す（新規ブランチ作成）、**期待結果**: 新規ブランチ作成画面に遷移し、同じレイアウトパターンで表示される
2. **前提条件**: サブ画面が表示されている、**操作**: qキーまたはESCキーを押す、**期待結果**: メイン画面（ブランチ一覧）に戻る
3. **前提条件**: Worktree管理画面が表示されている、**操作**: Worktreeを選択してアクションを実行する、**期待結果**: アクションが完了後、適切な画面に遷移する

---

### ユーザーストーリー 3 - リアルタイム統計情報の更新 (優先度: P3)

開発者がアプリケーションを使用中に、統計情報（ブランチ数、Worktree数、変更ファイル数など）がバックグラウンドで更新され、常に最新の状態が表示される。Git操作を実行した後、画面を再起動せずに統計が自動更新される。

**この優先度の理由**: 既存のinquirer実装にはない新機能であり、Ink.jsの強みを活かせるが、コア機能ではないため、P3とする。

**独立したテスト**: 統計情報の取得と更新ロジックを独立してテストでき、リアルタイム更新機能のみを検証できる。

**受け入れシナリオ**:

1. **前提条件**: アプリケーションが起動している、**操作**: 別のターミナルでGit操作（ブランチ作成、削除など）を実行する、**期待結果**: 数秒以内に統計情報が自動更新される
2. **前提条件**: ブランチ一覧が表示されている、**操作**: Worktreeを作成または削除する、**期待結果**: 操作完了後、統計情報が即座に更新される

---

### エッジケース

- **大量のブランチ（100個以上）が存在する場合**: スクロールのパフォーマンスが劣化せず、メモリ使用量が過度に増加しない
- **ターミナルサイズが極端に小さい場合（高さ10行以下）**: 最低限の情報（ヘッダー、少数のブランチ、フッター）が表示され、エラーにならない
- **ターミナルが色をサポートしていない場合**: アイコンとテキストのみで情報が識別可能
- **非常に長いブランチ名の場合**: 適切に切り詰められ、レイアウトが崩れない
- **並行Git操作が実行される場合**: データの整合性が保たれ、クラッシュしない
- **Reactコンポーネントでエラーが発生した場合**: Error Boundaryでキャッチされ、ユーザーに適切なエラーメッセージが表示される

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムは全画面レイアウト（ヘッダー固定、スクロール可能コンテンツ、フッター固定）を実装**しなければならない**
- **FR-002**: システムはターミナルサイズの変更を検出し、表示可能な行数を動的に再計算**しなければならない**
- **FR-003**: システムはブランチ一覧をスクロール可能なリストとして表示し、入りきらない場合のみスクロール機能を有効化**しなければならない**
- **FR-004**: システムは各ブランチにアイコン（ブランチタイプ、Worktree状態、変更状態、リモートマーク）を表示**しなければならない**
- **FR-005**: システムは統計情報（Local/Remote/Worktrees/Changes数）をヘッダー部分に1行で表示**しなければならない**
- **FR-006**: システムはキーボードナビゲーション（上下キー、Enter、q、n、m、c等）をサポート**しなければならない**
- **FR-007**: システムは既存のすべての機能（ブランチ選択・作成、Worktree管理、PRクリーンアップ、セッション管理、AIツール選択）を維持**しなければならない**
- **FR-008**: システムは各画面で一貫したレイアウトパターンを使用**しなければならない**
- **FR-009**: システムは画面遷移を状態管理で制御し、戻る操作をサポート**しなければならない**
- **FR-010**: システムはReactコンポーネントのエラーをError Boundaryでキャッチし、適切なエラーメッセージを表示**しなければならない**
- **FR-011**: システムはAIツール実行モード選択時に、Skip Permissions（Claude Code: --dangerously-skip-permissions / Codex CLI: --yolo）のYes/No選択を提供**しなければならない**
- **FR-012**: システムはAIツール（Claude Code / Codex CLI）終了後、自動的にメイン画面（ブランチ一覧）に戻り、ユーザーが継続して操作できる**しなければならない**
- **FR-013**: システムはGitリポジトリやブランチ情報の取得中にローディングインジケーター（例: スピナーや進行状況メッセージ）を表示し、処理が継続していることをユーザーに明示**しなければならない**

### 主要エンティティ *(機能がデータを含む場合は含める)*

- **Screen（画面）**: アプリケーションの各画面を表す（BranchList, WorktreeManager, BranchCreator, PRCleanup, AIToolSelector, SessionSelector）
- **BranchItem（ブランチアイテム）**: 表示用のブランチ情報（名前、アイコン、タイプ、状態）
- **Statistics（統計情報）**: リアルタイム更新される集計データ（ローカルブランチ数、リモートブランチ数、Worktree数、変更ファイル数）
- **Layout（レイアウト）**: 画面構成要素（Header, Content, Footer）とその配置

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: 開発者はブランチ一覧画面を1秒以内に表示できる（既存の実装と同等以上）
- **SC-002**: 100個以上のブランチが存在する場合でも、スクロール操作が遅延なく（レスポンス時間50ms以内）動作する
- **SC-003**: UIコードの総行数が既存実装（2522行）の70%削減され、約760行以下になる
- **SC-004**: 全画面レイアウトがターミナルサイズ変更から500ms以内に再計算され、再表示される
- **SC-005**: すべての既存機能が正常に動作し、機能の後退（regression）がゼロである
- **SC-006**: コンポーネント単体テストのカバレッジが80%以上達成される
- **SC-007**: 統合テストですべての画面遷移パターンが検証される
- **SC-008**: 開発者がターミナルをリサイズした際、レイアウトが自動調整され、手動での画面更新が不要である
- **SC-009**: Git情報の取得が300msを超えて継続する場合、ローディングインジケーターが500ms以内に表示され、処理完了まで更新され続ける
- **SC-010**: ローディングインジケーターの表示・非表示を検証する自動テストが追加され、TDDで開発された証跡（テスト先行コミットまたはテストケースの存在）が確認できる

## 制約と仮定 *(該当する場合)*

### 制約

- **既存のbun実行環境を維持する必要がある**（Node.jsへの変更は不可）
- **既存のVitest テストフレームワークを使用する**（新しいテストツールの導入は避ける）
- **既存のGit操作ロジック（`src/git.ts`, `src/worktree.ts`等）は変更しない**（UIレイヤーのみ移行）
- **既存のビジネスロジック（`src/services/*`, `src/repositories/*`）は保持する**
- **段階的移行が可能である必要がある**（一度にすべてを置き換えない）

### 仮定

- **Ink.jsはbun環境で正常に動作する**（互換性が確認されている）
- **開発者は最新のターミナルエミュレータを使用している**（基本的なANSIエスケープシーケンスをサポート）
- **React 18の基本的な機能（useState, useEffect, useMemo等）が使用可能である**
- **既存のユーザーは新しいUIに違和感なく移行できる**（キーボード操作が同じため）
- **ink-select-inputライブラリがスクロール機能を標準でサポートしている**

## 範囲外 *(必須)*

次の項目は、この機能の範囲外です：

- **マウス操作のサポート**（キーボード操作のみ）
- **カスタムテーマやカラースキームの提供**（デフォルトの色設定のみ）
- **アニメーションやトランジション効果**（シンプルな画面遷移のみ）
- **既存のビジネスロジックやGit操作の変更**（UIレイヤーのみ）
- **新機能の追加**（既存機能の維持のみ）
- **多言語対応**（日本語メッセージは維持するが、国際化機能は追加しない）
- **設定ファイルによるUI カスタマイズ**（固定レイアウトのみ）

## 技術要件・運用制約 *(2025-10-27追加)*

- Ink UI は起動時に端末入出力ストリームを確保し、`process.stdin` が TTY でない場合でも `/dev/tty` 等へのフォールバックによって TTY を取得すること。
- Ink UI 終了時および AI ツール等の子プロセス起動前には必ず raw mode を解除し、親プロセスの端末状態を元に戻すこと。解除漏れでキー入力が欠落しないことを以後の受け入れ条件とする。
- 子プロセスへ標準入出力を引き継ぐ際は、上記で確保した TTY ストリームを明示的に渡し、raw mode のまま `process.stdin` を共有しないこと。
- 端末制御の扱いは regresion を防ぐためユニットテストで担保すること（execa 呼び出し時に TTY ストリームと raw mode リセットが行われることを検証）。

## セキュリティとプライバシーの考慮事項 *(該当する場合)*

- **ターミナルへの入力内容はログに記録しない**（パスワードや機密情報の漏洩を防ぐ）
- **Error Boundaryでキャッチされたエラーには機密情報（ファイルパス、環境変数等）を含めない**
- **既存のセキュリティ対策を維持する**（Git操作の権限チェック等）

## 依存関係 *(該当する場合)*

- **ink**: ^5.0.0（メインUIフレームワーク）
- **react**: ^18.3.1（Inkの依存関係）
- **ink-select-input**: ^6.0.0（選択UIコンポーネント）
- **ink-text-input**: ^6.0.0（テキスト入力コンポーネント）
- **@types/react**: ^18.3.0（TypeScript型定義）
- **既存の依存関係**（chalk, execa等）は保持

## 参考資料 *(該当する場合)*

- [Ink.js公式ドキュメント](https://github.com/vadimdemedes/ink)
- [ink-select-input ドキュメント](https://github.com/vadimdemedes/ink-select-input)
- [既存のUI実装](../src/ui/)（移行前の参考実装）
- [プロジェクトのCLAUDE.md](../../CLAUDE.md)（開発指針）
