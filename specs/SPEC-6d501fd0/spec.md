# 機能仕様: Ink UI内蔵仮想ターミナル機能

**仕様ID**: `SPEC-6d501fd0`
**作成日**: 2025-01-26
**ステータス**: ドラフト
**入力**: ユーザー説明: "Ink UI内蔵仮想ターミナル機能"

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - コンテキスト情報付きAIツール実行 (優先度: P1)

開発者がブランチを選択し、AIツール（Claude CodeまたはCodex CLI）を起動すると、アプリケーションのUI内にターミナル画面が表示される。画面上部には、現在のブランチ名、選択したツール名、実行モード、作業ディレクトリパスが常に表示され、開発者は自分がどの環境で作業しているかを一目で確認できる。ターミナル領域では、AIツールとシームレスに対話でき、入力した内容と出力結果がリアルタイムで表示される。

**この優先度の理由**: この機能の最も基本的な価値を提供する。現在のUIでは、AIツール起動時にUIが消えてしまい、コンテキスト情報が失われる問題を解決する。開発者は作業環境を常に認識しながらAIツールを使用できる。

**独立したテスト**: ブランチ選択からAIツール起動、対話、終了までの一連のフローをテストすることで、基本的なユーザー価値を検証できる。

**受け入れシナリオ**:

1. **前提条件** ブランチ一覧画面が表示されている、**操作** ブランチを選択し、AIツールと実行モードを選択、**期待結果** ターミナル画面に遷移し、ヘッダーにブランチ名、ツール名、モード、作業ディレクトリパスが表示される
2. **前提条件** ターミナル画面が表示されている、**操作** キーボードで文字を入力、**期待結果** 入力がAIツールに送信され、応答が即座にターミナル領域に表示される
3. **前提条件** AIツールが実行中、**操作** AIツールが処理を完了、**期待結果** 自動的にブランチ一覧画面に戻る

---

### ユーザーストーリー 2 - AIツール実行の制御とログ保存 (優先度: P2)

開発者は、ターミナル画面でAIツールを実行中に、特定のキー操作で実行を制御できる。処理を中断したい場合はCtrl+Cで即座に終了し、一時的に停止したい場合はCtrl+Zで停止・再開できる。また、AIツールとの対話履歴を後で確認したい場合、Ctrl+Sで出力ログをファイルに保存できる。

**この優先度の理由**: 基本的な実行機能の上に、より高度な操作性を提供する。長時間実行されるタスクの制御や、後で参照するためのログ保存が可能になり、開発者の生産性が向上する。

**独立したテスト**: 各キーボードショートカット（Ctrl+C、Ctrl+Z、Ctrl+S）が正しく動作することを個別にテストできる。

**受け入れシナリオ**:

1. **前提条件** AIツールが実行中、**操作** Ctrl+Cを押下、**期待結果** AIツールの実行が即座に中断され、ブランチ一覧画面に戻る
2. **前提条件** AIツールが実行中、**操作** Ctrl+Zを押下、**期待結果** AIツールの実行が一時停止し、再度Ctrl+Zを押下すると再開される
3. **前提条件** ターミナル画面に出力が表示されている、**操作** Ctrl+Sを押下、**期待結果** 現在までの出力がログファイルに保存され、保存完了メッセージが表示される

---

### ユーザーストーリー 3 - 全画面表示による視認性向上 (優先度: P3)

開発者がF11キーを押すと、ヘッダーとフッターが非表示になり、ターミナル領域が画面全体に拡大される。長い出力を確認する際や、より多くの情報を一度に表示したい場合に、画面スペースを最大限に活用できる。

**この優先度の理由**: 基本機能と制御機能が実装された後の、UI体験の改善機能。必須ではないが、大量の出力を扱う場合のユーザビリティを向上させる。

**独立したテスト**: F11キー押下時にヘッダー/フッターの表示状態が切り替わることをテストできる。

**受け入れシナリオ**:

1. **前提条件** ターミナル画面が通常モードで表示されている、**操作** F11を押下、**期待結果** ヘッダーとフッターが非表示になり、ターミナル領域が画面全体に拡大される
2. **前提条件** 全画面モードが有効、**操作** 再度F11を押下、**期待結果** ヘッダーとフッターが再表示され、通常モードに戻る

---

### エッジケース

- AIツールの起動に失敗した場合、エラーメッセージを表示してブランチ一覧画面に戻る
- システムが双方向通信機能をサポートしていない環境の場合、警告メッセージを表示して従来の動作にフォールバックする
- ログ保存時にディスク容量が不足している場合、エラーメッセージを表示して保存を中止する
- AIツールが異常終了した場合、エラー情報を表示してブランチ一覧画面に戻る
- ユーザーが連続して複数回Ctrl+Cを押下した場合、プロセスを強制終了（SIGKILL送信）してブランチ一覧画面に即座に戻る

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムは、実行モード選択後、アプリケーションUIを維持したままターミナル画面に遷移しなければならない
- **FR-002**: ターミナル画面のヘッダーには、ブランチ名、AIツール名、実行モード、作業ディレクトリパスを表示しなければならない
- **FR-003**: システムは、AIツールを起動し、ユーザーとAIツール間の双方向通信を可能にしなければならない
- **FR-004**: ユーザーのキーボード入力は、遅延なくAIツールに送信されなければならない
- **FR-005**: AIツールの出力（テキスト装飾やカラー表示を含む）は、リアルタイムでターミナル領域に表示されなければならない
- **FR-006**: Ctrl+Cキー押下時、AIツールのプロセスを中断し、ブランチ一覧画面に戻らなければならない
- **FR-007**: Ctrl+Zキー押下時、AIツールのプロセスを一時停止し、再度押下時に再開しなければならない（注: Windows環境では一時停止機能は利用できず、Ctrl+Zは無効化される）
- **FR-008**: Ctrl+Sキー押下時、ターミナル出力をログファイルに保存しなければならない
- **FR-009**: F11キー押下時、ヘッダーとフッターの表示/非表示を切り替えなければならない
- **FR-010**: AIツール終了後、自動的にブランチ一覧画面に戻らなければならない
- **FR-011**: AIツール起動失敗時、エラーメッセージを表示してブランチ一覧画面に戻らなければならない
- **FR-012**: 双方向通信機能が利用できない環境では、警告メッセージを表示し、従来の動作にフォールバックしなければならない

### 主要エンティティ

- **ターミナルセッション**: AIツールの実行セッション情報（ブランチ名、ツール名、モード、作業ディレクトリパス、開始時刻、終了時刻）
- **ターミナル出力**: ターミナルに表示される出力データ（出力テキスト、タイムスタンプ、装飾情報）
- **ログファイル**: 保存された出力ログ（ファイルパス、保存時刻、ファイルサイズ）

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: 開発者は、実行モード選択完了からターミナル画面表示までを5秒以内に完了できる（双方向通信機能の初期化と最初のプロンプト表示を含む）
- **SC-002**: 開発者のキー入力は100ミリ秒以内にAIツールに送信される（キー押下から双方向通信機能への書き込み完了まで）
- **SC-003**: AIツールの出力は200ミリ秒以内に画面に表示される（双方向通信機能からのデータ受信から画面描画完了まで）
- **SC-004**: Ctrl+C、Ctrl+Z、Ctrl+S、F11の各操作が正常に動作する（成功率100%）
- **SC-005**: AIツール終了後、1秒以内にブランチ一覧画面に戻る
- **SC-006**: 1MB以下の出力を1秒以内にログファイルに保存できる
- **SC-007**: 色付きテキストやフォーマットが正しく表示される（視覚的検証）
- **SC-008**: 開発者の80%以上が「作業環境のコンテキストを常に把握できる」と評価する

## 制約と仮定 *(該当する場合)*

### 制約

- 既存のアプリケーションUIアーキテクチャに統合する必要がある
- Windows、macOS、Linuxの各プラットフォームで動作する必要がある
- 既存のブランチ一覧画面、AIツール選択画面、実行モード選択画面との互換性を維持する必要がある

### 仮定

- ユーザーは既にアプリケーションをインストール済みである
- ユーザーは既にGitリポジトリ内で作業している
- ユーザーの端末はテキスト装飾とカラー表示をサポートしている
- ログファイルはプロジェクトルートの`.logs/`ディレクトリに保存される
- 双方向通信機能は大半の環境でサポートされている

## 範囲外 *(必須)*

次の項目は、この機能の範囲外です：

- AIツール（Claude Code、Codex CLI）自体の機能追加・変更
- ターミナルエミュレータの高度な機能（タブ、分割画面、カスタムテーマなど）
- 既存のブランチ一覧画面、AIツール選択画面、実行モード選択画面の大幅な変更
- ログファイルの自動削除・管理・検索機能
- ターミナル履歴の永続化・復元機能
- リモートマシンでのAIツール実行
- カスタムキーバインディング設定

## セキュリティとプライバシーの考慮事項 *(該当する場合)*

- ログファイルには機密情報（APIキー、パスワードなど）が含まれる可能性があるため、適切なファイルパーミッション（読み取り/書き込みは所有者のみ）を設定する
- ユーザーの入力は加工せずにAIツールに送信されるため、セキュリティ検証はAIツール側で実施される

## 依存関係 *(該当する場合)*

- 既存のブランチ一覧画面（戻り先の画面）
- 既存のAIツール選択画面
- 既存の実行モード選択画面
- 既存のAIツール起動機能

## 参考資料 *(該当する場合)*

- [ANSI制御コード仕様](https://en.wikipedia.org/wiki/ANSI_escape_code)
