# 機能仕様: PR自動マージ機能

**仕様ID**: `SPEC-cff08403`
**作成日**: 2025-10-25
**ステータス**: ドラフト
**入力**: ユーザー説明: "PRの自動マージ機能を実装します。GitHub Actionsを使用して、CIが成功し競合がない場合に、すべてのPRを自動的にMerge commitでマージします。ラベル判定は不要で、条件を満たせば即座にマージします。"

## ユーザーシナリオとテスト

### ユーザーストーリー 1 - 自動マージの基本フロー (優先度: P1)

開発者がPRを作成し、すべてのCIチェックが成功したとき、手動操作なしで自動的にベースブランチにマージされます。これにより、開発者はマージ完了を待つ必要がなく、次のタスクに集中できます。

**この優先度の理由**: これは機能の中核であり、開発ワークフローの自動化と効率化を実現します。手動マージ待ちの時間を削減し、開発速度を向上させます。

**独立したテスト**: PRを作成し、CIが成功することを確認し、PRが自動的にマージされることをテストすることで、基本的な価値を提供できます。

**受け入れシナリオ**:

1. **前提条件** PRが作成されている、**操作** すべてのCIワークフロー（Test、Lint）が成功する、**期待結果** 自動マージワークフローが起動される
2. **前提条件** 自動マージワークフローが起動した、**操作** PRの競合状態を確認、**期待結果** 競合がない場合、PRが自動的にマージされる
3. **前提条件** PRがマージされた、**操作** ブランチの状態を確認、**期待結果** PRのコミットがベースブランチに反映されている
4. **前提条件** マージ方法が指定されていない、**操作** デフォルトのマージ方法を確認、**期待結果** Merge commitとしてマージされている
5. **前提条件** PRに未解決のコメントがある、**操作** CI成功後の処理を確認、**期待結果** コメントに関係なく、CIが成功していればマージされる

---

### ユーザーストーリー 2 - エラー処理とスキップ (優先度: P1)

開発者がPRを作成したが、CIが失敗した場合、または競合が発生している場合、自動マージはスキップされ、PRは手動マージ待ち状態のままとなります。

**この優先度の理由**: 品質を保証するため、問題のあるコードが自動的にマージされないようにする必要があります。これは基本的な安全機能です。

**独立したテスト**: CIが失敗するPRや競合のあるPRを作成し、自動マージがスキップされることを確認できます。

**受け入れシナリオ**:

1. **前提条件** PRが作成されている、**操作** いずれかのCIワークフローが失敗する、**期待結果** 自動マージワークフローは実行されるが、マージはスキップされる
2. **前提条件** PRにマージ競合がある、**操作** 自動マージワークフローが実行される、**期待結果** 競合を検出し、マージはスキップされる
3. **前提条件** PRがドラフト状態である、**操作** CI成功後の処理を確認、**期待結果** ドラフトPRは自動マージの対象外として処理される
4. **前提条件** 自動マージがスキップされた、**操作** ワークフローのログを確認、**期待結果** スキップの理由が明確に記録されている

---

### ユーザーストーリー 3 - 複数ワークフローの同期 (優先度: P2)

開発者のPRに対して複数のCIワークフローが並行実行されるとき、すべてのワークフローが完了するまで待機し、すべて成功した時点で自動マージが実行されます。

**この優先度の理由**: 実環境では複数のCIワークフローが存在するため、すべてのチェックが完了してからマージする必要があります。ただし、基本機能の後に実装可能です。

**独立したテスト**: 複数のCIワークフローを持つPRを作成し、すべてが成功するまで待機し、その後マージされることを確認できます。

**受け入れシナリオ**:

1. **前提条件** PRに対してTest、Lintワークフローが実行中、**操作** Testワークフローが先に成功する、**期待結果** Lintワークフローの完了を待機する
2. **前提条件** 最後のワークフローが成功した、**操作** 自動マージワークフローが起動、**期待結果** すべてのワークフローの成功を確認してからマージする
3. **前提条件** 複数のワークフローが実行中、**操作** いずれか1つが失敗する、**期待結果** 他のワークフローの結果に関係なく、マージはスキップされる

---

### エッジケース

- CIワークフローが実行中にPRが閉じられた場合、自動マージはスキップされる
- 自動マージ実行中にベースブランチが更新され競合が発生した場合、マージは失敗し手動介入が必要になる
- GitHub Actionsの権限が不足している場合、マージは失敗しエラーログが記録される
- PRが既にマージ済みの場合、重複マージを試行せず正常終了する
- ネットワークエラーや一時的なAPI障害が発生した場合、適切なエラーメッセージが記録される

## 要件

### 機能要件

- **FR-001**: システムは、すべての必須CIワークフロー（Test、Lint）の完了を検出**しなければならない**
- **FR-002**: システムは、すべてのCIワークフローが成功したことを確認**しなければならない**
- **FR-003**: システムは、PRのマージ可能状態（競合の有無）を確認**しなければならない**
- **FR-004**: システムは、ドラフトPRを自動マージの対象から除外**しなければならない**
- **FR-005**: システムは、すべての条件を満たすPRをMerge commit方式でマージ**しなければならない**
- **FR-006**: システムは、マージ失敗時に適切なエラーログを記録**しなければならない**
- **FR-007**: システムは、マージスキップ時にその理由をログに記録**しなければならない**
- **FR-008**: システムは、既にマージ済みのPRに対して重複処理を行わない**しなければならない**

### 主要エンティティ

- **PR（プルリクエスト）**: マージ対象となるコード変更。状態（オープン、ドラフト、マージ済み）、マージ可能性（競合の有無）、関連するCIステータスを持つ
- **CIワークフロー**: PRに対して実行される自動テスト。Test、Lintなどの種類があり、各ワークフローは成功、失敗、実行中のいずれかの状態を持つ
- **マージ状態**: PRのマージに関する情報。マージ可能性、競合状態、マージ方法を含む

## 成功基準

### 測定可能な成果

- **SC-001**: CIが成功したPRの95%以上が、最後のCIワークフロー完了から5分以内に自動マージされる
- **SC-002**: 競合やCI失敗によるマージスキップが100%正確に検出され、不適切なマージが発生しない
- **SC-003**: 自動マージ機能の導入により、PRマージにかかる平均時間が50%以上短縮される
- **SC-004**: 自動マージワークフローの実行失敗率が1%未満である

## 制約と仮定

### 制約

- GitHub Actionsの実行時間制限（ジョブあたり最大6時間）内で完了する必要がある
- GitHub APIのレート制限を考慮する必要がある
- ブランチ保護ルールが設定されている場合、それらを遵守する必要がある
- GitHub Actionsのワークフロートークンに必要な権限（contents: write, pull-requests: write）が必要

### 仮定

- PRのターゲットブランチはmainまたはdevelopである
- 既存のCIワークフロー（Test、Lint）が正常に動作している
- GitHubリポジトリでGitHub Actionsが有効化されている
- リポジトリへの書き込み権限を持つトークンが利用可能である

## 範囲外

次の項目は、この機能の範囲外です：

- レビュー承認の要求と確認（ブランチ保護ルールに委ねる）
- ラベルベースの条件付きマージ
- マージ前の追加テストやデプロイ検証
- カスタムマージコミットメッセージの生成
- マージ後の通知機能（Slackなど）
- Squash mergeやRebase mergeなど、Merge commit以外のマージ方法
- 複数のベースブランチに対する同時マージ
- マージ優先度の管理

## セキュリティとプライバシーの考慮事項

- 自動マージワークフローは必要最小限の権限（contents: write, pull-requests: write）のみを使用する
- GitHub Actionsのトークンは自動的に有効期限が設定されるため、長期的な権限リークのリスクは低い
- ブランチ保護ルールと連携し、保護されたブランチへの直接プッシュを防止する
- CIの成功を必須条件とすることで、セキュリティスキャンやテストをバイパスできないようにする
- ワークフローのログには機密情報を含めないようにする

## 依存関係

- 既存のCIワークフロー: Test（test、test-node、buildジョブ）
- 既存のCIワークフロー: Lint（lint、commitlint、markdownlintジョブ）
- GitHub Actions: ワークフローの実行環境
- GitHub CLI（gh）: PR情報の取得とマージ実行
- GitHub API: PR状態の確認とマージ操作

## 参考資料

- GitHub Actions公式ドキュメント: workflow_runトリガー
- GitHub CLI公式ドキュメント: pr merge コマンド
- プロジェクトの既存CIワークフロー: `.github/workflows/test.yml`, `.github/workflows/lint.yml`
