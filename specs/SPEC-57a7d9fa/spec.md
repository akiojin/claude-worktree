# 機能仕様: Worktreeディレクトリパスを`.git/worktree`から`.worktrees`に変更

**仕様ID**: `SPEC-57a7d9fa`
**作成日**: 2025-10-31
**ステータス**: ドラフト
**入力**: ユーザー説明: "Worktreeディレクトリパスを.git/worktreeから.worktreesに変更する機能"

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - 新規Worktree作成時の配置先変更 (優先度: P1)

開発者がclaude-worktreeツールを使用して新しいブランチのWorktreeを作成する際、リポジトリルート直下の`.worktrees`ディレクトリに作成されるようになります。これにより、`.git`ディレクトリ内部に配置されていた従来の方法から、より分かりやすい場所にWorktreeが配置されます。

**この優先度の理由**: Worktreeの作成場所を変更する本機能の核心部分であり、ユーザーが直接体験する主要な変更です。

**独立したテスト**: 新しいブランチでWorktreeを作成し、`.worktrees/[ブランチ名]`ディレクトリが作成されることを確認することで完全にテストできます。

**受け入れシナリオ**:

1. **前提条件** Gitリポジトリ内で、**操作** claude-worktreeコマンドで新規ブランチのWorktreeを作成、**期待結果** `.worktrees/[ブランチ名]`ディレクトリが作成される
2. **前提条件** `.worktrees`ディレクトリが存在しない状態で、**操作** 初めてWorktreeを作成、**期待結果** `.worktrees`ディレクトリが自動的に作成され、その配下にWorktreeディレクトリが作成される
3. **前提条件** 特殊文字を含むブランチ名で、**操作** Worktreeを作成、**期待結果** サニタイズされた安全なディレクトリ名で`.worktrees`配下に作成される

---

### ユーザーストーリー 2 - Gitによる管理対象外の設定 (優先度: P2)

開発者がWorktreeを作成すると、`.worktrees`ディレクトリがGitの管理対象外として`.gitignore`に自動的に追加されます。これにより、Worktree内の作業ファイルが誤ってコミットされることを防ぎます。

**この優先度の理由**: Worktreeの動作に必須ではありませんが、実用上重要な設定であり、ユーザーの手動設定を省略できます。

**独立したテスト**: `.gitignore`ファイルを確認し、`.worktrees/`エントリーが含まれていることを検証することで完全にテストできます。

**受け入れシナリオ**:

1. **前提条件** `.gitignore`ファイルが存在する状態で、**操作** 機能を適用、**期待結果** `.gitignore`に`.worktrees/`エントリーが追加される
2. **前提条件** `.gitignore`ファイルが存在しない状態で、**操作** 機能を適用、**期待結果** `.gitignore`ファイルが作成され、`.worktrees/`エントリーが含まれる
3. **前提条件** `.gitignore`に既に`.worktrees/`が存在する状態で、**操作** 機能を適用、**期待結果** 重複せず、既存のエントリーがそのまま維持される

---

### ユーザーストーリー 3 - 既存Worktreeの互換性維持 (優先度: P3)

既存の`.git/worktree`配下に作成済みのWorktreeは、新しい実装後も影響を受けず、そのまま動作し続けます。開発者は既存のWorktreeを手動で移行する必要がなく、新規作成分のみ新しい場所に配置されます。

**この優先度の理由**: 既存ユーザーの作業環境を保護し、移行コストをゼロにするための後方互換性機能です。

**独立したテスト**: 既存の`.git/worktree/[ブランチ名]`ディレクトリでGitコマンドが正常に動作することを確認することで完全にテストできます。

**受け入れシナリオ**:

1. **前提条件** `.git/worktree`配下に既存のWorktreeが存在する状態で、**操作** Gitコマンドを実行、**期待結果** 既存Worktreeで正常にGit操作が実行できる
2. **前提条件** 既存と新規のWorktreeが混在する状態で、**操作** 各Worktreeで開発作業を実行、**期待結果** 両方のWorktreeで問題なく動作する

---

### エッジケース

- `.worktrees`という名前のファイルが既に存在する場合、エラーメッセージを表示して処理を中断する
- ディスク容量が不足している場合、適切なエラーメッセージを表示する
- `.gitignore`ファイルが読み取り専用の場合、適切なエラーメッセージを表示する
- 同名のブランチが既に`.worktrees`配下に存在する場合、エラーメッセージを表示する

## 要件 *(必須)*

### 機能要件

- **FR-001**: `generateWorktreePath`メソッドは、リポジトリルート直下の`.worktrees/[ブランチ名]`パスを生成**しなければならない**
- **FR-002**: `.git/worktree`から`.worktrees`へのパス変更により、既存のWorktree作成ロジックが正常に動作し続ける**こと**
- **FR-003**: `.gitignore`ファイルに`.worktrees/`エントリーを追加する機能を実装**しなければならない**
- **FR-004**: 既存の`.git/worktree`配下のWorktreeには一切の変更を加えず、そのまま動作し続ける**こと**
- **FR-005**: テストコードも新しいパス（`.worktrees`）に対応するように更新**しなければならない**
- **FR-006**: ビルドプロセスがエラーなく完了する**こと**

### 主要エンティティ

- **Worktreeパス**: リポジトリルートからWorktreeディレクトリへの相対パスを表す文字列。従来は`.git/worktree/[ブランチ名]`、変更後は`.worktrees/[ブランチ名]`
- **Gitignoreエントリー**: `.gitignore`ファイル内の`.worktrees/`という行。Git管理対象外を指定する

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: 新規作成される全てのWorktreeが`.worktrees/`配下に配置される
- **SC-002**: `.worktrees/`ディレクトリがGit管理対象外として正しく設定される
- **SC-003**: 既存の`.git/worktree`配下のWorktreeが影響を受けず、引き続き正常に動作する
- **SC-004**: `bun run build`が成功し、`bun test`で全てのテストが通過する
- **SC-005**: Worktree作成時のパフォーマンスが従来と同等またはそれ以上である

## 制約と仮定 *(該当する場合)*

### 制約

- 既存の`generateWorktreePath`メソッドのシグネチャは変更しない
- 既存の`.git/worktree`配下のWorktreeは移行しない（新規作成のみ新パスを使用）
- Git worktreeの標準機能を使用し、独自の拡張は行わない

### 仮定

- リポジトリルートに`.worktrees`ディレクトリを作成する権限がある
- `.gitignore`ファイルは編集可能である
- ユーザーはGit 2.5以降のworktree機能をサポートするバージョンを使用している

## 範囲外 *(必須)*

次の項目は、この機能の範囲外です：

- 既存の`.git/worktree`配下のWorktreeを`.worktrees`に移行する機能
- `.worktrees`ディレクトリの場所をユーザーが設定可能にする機能
- Worktree作成以外の操作（削除、一覧表示など）の変更
- マルチリポジトリ環境での共有Worktreeディレクトリ機能

## セキュリティとプライバシーの考慮事項 *(該当する場合)*

- `.worktrees`ディレクトリのパーミッションは、リポジトリルートのパーミッションを継承する
- `.gitignore`への追加により、Worktree内の機密情報が誤ってコミットされるリスクを軽減する

## 依存関係 *(該当する場合)*

- Node.js `path`モジュール（パス操作用）
- `execa`パッケージ（Gitコマンド実行用）
- Git CLI（worktree機能）
- 既存のWorktreeService実装

## 参考資料 *(該当する場合)*

- [Git worktree公式ドキュメント](https://git-scm.com/docs/git-worktree)
- [既存実装: src/worktree.ts](../../src/worktree.ts)
